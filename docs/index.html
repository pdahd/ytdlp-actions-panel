<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>yt-dlp Actions Panel</title>
  <style>
    /* ====== 修复核心：避免 width + padding 溢出 ====== */
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg: #0b1020;
      --fg: #e8ecff;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --border2: rgba(255,255,255,.18);
      --muted: rgba(232,236,255,.80);
      --input-bg: rgba(0,0,0,.25);
      --pre-bg: rgba(0,0,0,.35);
      --btn: #4b6bff;
      --link: #9db2ff;
      --gap: 12px;
      --radius: 16px;
      --radius2: 12px;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", Arial;
      background: var(--bg);
      color: var(--fg);
    }

    .wrap {
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
    }

    .muted { opacity: .85; font-size: 13px; color: var(--muted); }

    a { color: var(--link); }

    hr {
      border: 0;
      border-top: 1px solid var(--border);
      margin: 14px 0;
    }

    /* ====== 表单布局：桌面两列，移动端单列 ====== */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }

    /* 关键：grid 子项允许收缩，避免溢出/重叠 */
    .grid > * { min-width: 0; }

    .full {
      grid-column: 1 / -1;
      min-width: 0;
    }

    label {
      display: block;
      font-size: 13px;
      opacity: .92;
      margin-bottom: 6px;
    }

    input, select {
      width: 100%;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border2);
      background: var(--input-bg);
      color: var(--fg);
      outline: none;
    }

    /* ====== 时间设置行：启用(窄) + start/end(宽)，并确保不重叠 ====== */
    .time-grid {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: minmax(110px, 150px) 1fr 1fr;
      gap: var(--gap);
      align-items: end;
    }
    .time-grid > * { min-width: 0; }

    /* ====== 按钮/行布局 ====== */
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      min-width: 0;
    }

    button {
      padding: 10px 14px;
      border-radius: var(--radius2);
      border: 1px solid var(--border2);
      background: var(--btn);
      color: #fff;
      cursor: pointer;
      max-width: 100%;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--pre-bg);
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 640px; /* 让手机端横向滚动而不是挤爆布局 */
    }
    td, th {
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 8px;
      font-size: 13px;
      vertical-align: top;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(0,0,0,.12);
    }
    .table-wrap table { border: 0; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.15);
      font-size: 12px;
      opacity: .9;
      margin-left: 6px;
    }

    /* ====== 响应式断点：小屏变单列 ====== */
    @media (max-width: 720px){
      .wrap { padding: 0 12px; }
      .grid { grid-template-columns: 1fr; }
    }

    /* 更窄屏：时间区变“启用一行 + start/end 两列” */
    @media (max-width: 520px){
      .time-grid {
        grid-template-columns: 1fr;
      }
      .time-grid .time-pair {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
      }
      .time-grid .time-pair > * { min-width: 0; }
    }

    /* 极窄屏：start/end 也堆叠，绝不重叠 */
    @media (max-width: 380px){
      .time-grid .time-pair { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px;">yt-dlp Actions 控制台</h2>
      <div class="muted">网页表单 → Cloudflare Worker → workflow_dispatch → 轮询 run/jobs → 展示结果 + artifacts 下载</div>

      <hr>

      <form id="f">
        <div class="grid">
          <div>
            <label>操作类型</label>
            <select name="action_type">
              <option>查询</option>
              <option>下载</option>
            </select>
          </div>

          <div>
            <label>视频格式代码（下载用）</label>
            <input name="video_format" placeholder="例如 251 / 137+140 等">
          </div>

          <div class="full">
            <label>YouTube 视频链接</label>
            <input name="video_link" required placeholder="https://www.youtube.com/watch?v=...">
          </div>

          <!-- 时间设置：启用(窄) + start/end(宽) -->
          <div class="time-grid">
            <div>
              <label>启用指定时间段</label>
              <select name="enable_sections">
                <option>否</option>
                <option>是</option>
              </select>
            </div>

            <!-- 在窄屏时 start/end 作为一组做两列 -->
            <div class="time-pair" style="display: contents;">
              <div>
                <label>开始时间</label>
                <input name="start_time" placeholder="mm:ss 或 hh:mm:ss">
              </div>
              <div>
                <label>结束时间</label>
                <input name="end_time" placeholder="mm:ss 或 hh:mm:ss">
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button id="btn" type="submit">提交并运行</button>
          <span id="status" class="muted"></span>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="row">
        <div><b>运行信息</b></div>
        <div class="muted" id="runMeta"></div>
      </div>

      <div id="steps"></div>

      <h3 style="margin-top:16px;">Artifacts（构建工件）</h3>
      <div class="muted" id="artNote">（运行完成后自动加载）</div>
      <div id="artifacts"></div>

      <h3 style="margin-top:16px;">查询结果（formats.txt）</h3>
      <pre id="result">(等待查询完成...)</pre>
    </div>
  </div>

<script type="module">
  import { unzipSync, strFromU8 } from "https://cdn.jsdelivr.net/npm/fflate@0.8.2/esm/browser.js";

  const WORKER_BASE = "https://ytdlp-actions-panel-api.yswwsy.workers.dev";

  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function renderSteps(jobsJson){
    const jobs = jobsJson.jobs || [];
    let html = `<div class="table-wrap"><table><thead><tr><th>Job</th><th>Step</th><th>Status</th><th>Conclusion</th></tr></thead><tbody>`;
    for(const job of jobs){
      for(const s of (job.steps || [])){
        html += `<tr>
          <td>${esc(job.name || "")}</td>
          <td>${esc(s.name || "")}</td>
          <td>${esc(s.status || "")}</td>
          <td>${esc(s.conclusion || "")}</td>
        </tr>`;
      }
    }
    html += "</tbody></table></div>";
    $("steps").innerHTML = html;
  }

  function humanBytes(n){
    if (n == null) return "";
    const units = ["B","KB","MB","GB"];
    let i = 0, x = Number(n);
    while (x >= 1024 && i < units.length-1){ x/=1024; i++; }
    return `${x.toFixed(i===0?0:2)} ${units[i]}`;
  }

  function renderArtifacts(runId, requestId, artifactsJson){
    const arts = artifactsJson.artifacts || [];
    if(!arts.length){
      $("artifacts").innerHTML = "<div class='muted'>（该 run 没有 artifacts）</div>";
      return;
    }

    const queryName = `query-result-${requestId}`;
    const downloadName = `downloaded-videos-${requestId}`;

    let html = `<div class="table-wrap"><table><thead><tr><th>Name</th><th>Size</th><th>操作</th></tr></thead><tbody>`;

    for(const a of arts){
      const name = a.name;
      const size = a.size_in_bytes;

      const proxyZip = `${WORKER_BASE}/artifact-zip?run_id=${encodeURIComponent(runId)}&name=${encodeURIComponent(name)}`;
      const ghUi = `https://github.com/pdahd/ytdlp-actions-panel/actions/runs/${encodeURIComponent(runId)}/artifacts/${encodeURIComponent(a.id)}`;

      const badges = [];
      if(name === queryName) badges.push(`<span class="pill">query</span>`);
      if(name === downloadName) badges.push(`<span class="pill">download</span>`);

      html += `<tr>
        <td>${esc(name)} ${badges.join(" ")}</td>
        <td>${esc(humanBytes(size))}</td>
        <td>
          <a href="${proxyZip}">下载zip（经Worker）</a>
          &nbsp;|&nbsp;
          <a href="${ghUi}" target="_blank">GitHub链接</a>
        </td>
      </tr>`;
    }

    html += "</tbody></table></div>";
    $("artifacts").innerHTML = html;
  }

  async function fetchJSON(path){
    const r = await fetch(WORKER_BASE + path, { credentials: "include" });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  async function postJSON(path, body){
    const r = await fetch(WORKER_BASE + path, {
      method:"POST",
      credentials: "include",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  $("f").addEventListener("submit", async (e) => {
    e.preventDefault();
    $("btn").disabled = true;

    $("result").textContent = "(等待查询完成...)";
    $("steps").innerHTML = "";
    $("runMeta").textContent = "";
    $("artifacts").innerHTML = "";
    $("artNote").textContent = "（运行完成后自动加载）";
    $("status").textContent = "正在触发工作流...";

    const fd = new FormData(e.target);
    const request_id = uuid();

    const inputs = {
      request_id,
      action_type: fd.get("action_type"),
      video_link: fd.get("video_link"),
      video_format: fd.get("video_format") || "",
      enable_sections: fd.get("enable_sections") || "否",
      start_time: fd.get("start_time") || "",
      end_time: fd.get("end_time") || "",
    };

    if(inputs.action_type === "下载" && !inputs.video_format){
      alert("下载模式需要填写 视频格式代码");
      $("btn").disabled = false;
      return;
    }

    await postJSON("/dispatch", { ref: "main", inputs });
    $("status").textContent = `已触发，request_id=${request_id}，正在定位 run...`;

    let run = null;
    for(let i=0;i<45;i++){
      const res = await fetchJSON(`/resolve?request_id=${encodeURIComponent(request_id)}`);
      if(res.found){ run = res.run; break; }
      await sleep(1000);
    }
    if(!run){
      $("status").textContent = "未能定位到 run（可能 GitHub 延迟）。请稍后重试或去 Actions 页面查看。";
      $("btn").disabled = false;
      return;
    }

    const runId = run.id;
    $("runMeta").innerHTML = `run_id=${runId} | <a href="${run.html_url}" target="_blank">打开 GitHub 运行页面</a>`;
    $("status").textContent = "运行中...";

    let runInfo = null;
    while(true){
      runInfo = await fetchJSON(`/run?run_id=${runId}`);
      const jobs = await fetchJSON(`/jobs?run_id=${runId}`);
      renderSteps(jobs);

      const st = `${runInfo.status}${runInfo.conclusion ? " / " + runInfo.conclusion : ""}`;
      $("status").textContent = `状态：${st}`;

      if(runInfo.status === "completed") break;
      await sleep(2000);
    }

    try {
      $("artNote").textContent = "正在加载 artifacts...";
      const arts = await fetchJSON(`/artifacts?run_id=${runId}`);
      renderArtifacts(runId, request_id, arts);
      $("artNote").textContent = `共 ${arts.total_count ?? (arts.artifacts||[]).length} 个 artifacts`;
    } catch (err) {
      $("artNote").textContent = "加载 artifacts 失败：" + String(err);
    }

    if(inputs.action_type === "查询" && runInfo.conclusion === "success"){
      const artName = `query-result-${request_id}`;
      $("status").textContent = "查询已完成，正在获取 formats.txt ...";

      const zipResp = await fetch(WORKER_BASE + `/artifact-zip?run_id=${runId}&name=${encodeURIComponent(artName)}`, { credentials:"include" });
      if(!zipResp.ok){
        $("result").textContent = "下载查询结果 artifact 失败：" + await zipResp.text();
      }else{
        const buf = await zipResp.arrayBuffer();
        const files = unzipSync(new Uint8Array(buf));
        const key = Object.keys(files).find(k => k.endsWith("formats.txt"));
        if(!key){
          $("result").textContent = "zip 中未找到 formats.txt";
        }else{
          $("result").textContent = strFromU8(files[key]);
        }
      }
    } else {
      $("result").textContent = "（非查询模式，或运行失败。请在上方 Artifacts 区下载成品；或打开 GitHub 运行页面查看日志。）";
    }

    $("btn").disabled = false;
  });
</script>
</body>
</html>
