<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>yt-dlp Actions Panel</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      /* æ›´äº®çš„æš—è‰²èƒŒæ™¯ + å†·è‰²é‡‘å±é£ */
      --bg0: #0a1224;
      --bg1: #101b33;
      --bg2: #0a0f1d;

      --text: #eef2ff;
      --muted: rgba(238,242,255,.80);

      /* é‡‘å±/ç»ç’ƒé¢æ¿ */
      --card: rgba(255,255,255,.075);
      --card2: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.16);
      --border2: rgba(255,255,255,.22);

      --input-bg: rgba(10,14,25,.55);
      --pre-bg: rgba(8,10,18,.60);

      --link: #a9baff;
      --btn: linear-gradient(180deg, #5f7cff 0%, #3f60ff 100%);
      --btn-border: rgba(255,255,255,.22);

      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);

      --radius: 18px;
      --radius2: 12px;
      --gap: 12px;
    }

    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", Arial;
      color: var(--text);

      /* å¤šå±‚æ¸å˜ï¼šæ›´äº®ã€æœ‰å±‚æ¬¡ */
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(120,160,255,.28), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(1000px 700px at 50% 110%, rgba(110,255,220,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg2) 100%);
      background-attachment: fixed;
    }

    .wrap{ max-width: 980px; margin: 22px auto; padding: 0 16px; }

    a{ color: var(--link); }

    .muted{ opacity: .9; font-size: 13px; color: var(--muted); }

    /* é‡‘å±å¡ç‰‡ï¼šæ¸å˜è¾¹æ¡† + é«˜å…‰ + å†…é˜´å½± */
    .card{
      position: relative;
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)) padding-box,
        linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.08), rgba(255,255,255,.22)) border-box;
      border: 1px solid transparent;
      box-shadow: var(--shadow);
      padding: 18px;
      overflow: hidden;
    }

    /* é¡¶éƒ¨é•€é“¬é«˜å…‰æ¡ */
    .card::before{
      content:"";
      position:absolute;
      left: -10%;
      right: -10%;
      top: -28px;
      height: 74px;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,.16) 20%,
        rgba(255,255,255,.06) 45%,
        rgba(255,255,255,.14) 70%,
        transparent 100%);
      transform: rotate(-2deg);
      pointer-events:none;
      filter: blur(.2px);
    }

    /* ç»ç’ƒæ¨¡ç³Šï¼ˆå¯é€‰ï¼Œå…¼å®¹åˆ™ç”Ÿæ•ˆï¼Œä¸å…¼å®¹åˆ™å¿½ç•¥ï¼‰ */
    .card{
      backdrop-filter: blur(10px) saturate(140%);
      -webkit-backdrop-filter: blur(10px) saturate(140%);
    }

    hr{
      border: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
      margin: 14px 0;
    }

    .grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }
    .grid > * { min-width: 0; }
    .full{ grid-column: 1 / -1; min-width: 0; }

    label{ display:block; font-size: 13px; opacity: .95; margin-bottom: 6px; }

    input, select{
      width: 100%;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border2);
      background: var(--input-bg);
      color: var(--text);
      outline: none;

      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        inset 0 -10px 25px rgba(0,0,0,.22);
    }

    input:focus, select:focus{
      border-color: rgba(160,190,255,.55);
      box-shadow:
        0 0 0 3px rgba(95,124,255,.18),
        inset 0 1px 0 rgba(255,255,255,.10),
        inset 0 -10px 25px rgba(0,0,0,.22);
    }

    .time-grid{
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: minmax(110px, 150px) 1fr 1fr;
      gap: var(--gap);
      align-items: end;
    }
    .time-grid > * { min-width: 0; }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; min-width:0; }

    button{
      padding: 10px 14px;
      border-radius: var(--radius2);
      border: 1px solid var(--btn-border);
      background: var(--btn);
      color:#fff;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    button:disabled{ opacity: .6; cursor:not-allowed; }

    pre{
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--pre-bg);
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      overflow:auto;
    }

    .table-wrap{
      width: 100%;
      overflow-x: auto;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    table{ width:100%; border-collapse: collapse; min-width: 720px; }
    td, th{ border-bottom: 1px solid rgba(255,255,255,.10); padding: 8px; font-size: 13px; vertical-align: top; }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:12px;
      opacity:.95;
      margin-left:6px;
      background: rgba(255,255,255,.05);
    }

    .thumb{
      width: 96px;
      height: 54px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      display:block;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    .badge-img{
      height: 28px;
      max-width: 100%;
      vertical-align: middle;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
    }

    @media (max-width: 720px){
      .wrap{ padding: 0 12px; }
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      .time-grid{ grid-template-columns: 1fr; }
      .time-grid .time-pair{
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
      }
      .time-grid .time-pair > *{ min-width:0; }
    }
    @media (max-width: 380px){
      .time-grid .time-pair{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px;">yt-dlp Actions æ§åˆ¶å°</h2>
      <div class="muted">ç½‘é¡µè¡¨å• â†’ Cloudflare Worker â†’ workflow_dispatch â†’ è½®è¯¢ run/jobs â†’ å±•ç¤ºç»“æœ + artifacts ä¸‹è½½</div>

      <hr>

      <form id="f">
        <div class="grid">
          <div>
            <label>æ“ä½œç±»å‹</label>
            <select name="action_type">
              <option>æŸ¥è¯¢</option>
              <option>ä¸‹è½½</option>
            </select>
          </div>

          <div>
            <label>è§†é¢‘æ ¼å¼ä»£ç ï¼ˆä¸‹è½½ç”¨ï¼‰</label>
            <input name="video_format" placeholder="ä¾‹å¦‚ 251 / 137+140 / bestvideo+bestaudio ç­‰">
          </div>

          <div class="full">
            <label>YouTube è§†é¢‘é“¾æ¥</label>
            <input name="video_link" required placeholder="https://www.youtube.com/watch?v=...">
          </div>

          <div class="time-grid">
            <div>
              <label>å¯ç”¨æŒ‡å®šæ—¶é—´æ®µ</label>
              <select name="enable_sections">
                <option>å¦</option>
                <option>æ˜¯</option>
              </select>
            </div>

            <div class="time-pair" style="display: contents;">
              <div>
                <label>å¼€å§‹æ—¶é—´</label>
                <input name="start_time" placeholder="mm:ss æˆ– hh:mm:ss">
              </div>
              <div>
                <label>ç»“æŸæ—¶é—´</label>
                <input name="end_time" placeholder="mm:ss æˆ– hh:mm:ss">
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button id="btn" type="submit">æäº¤å¹¶è¿è¡Œ</button>
          <span id="status" class="muted"></span>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="row">
        <div><b>è¿è¡Œä¿¡æ¯</b></div>
        <div class="muted" id="runMeta"></div>
      </div>

      <div id="steps"></div>

      <h3 style="margin-top:16px;">Artifactsï¼ˆæ„å»ºå·¥ä»¶ï¼‰</h3>
      <div class="muted" id="artNote">ï¼ˆè¿è¡Œå®Œæˆåè‡ªåŠ¨åŠ è½½ï¼‰</div>
      <div id="artifacts"></div>

      <h3 style="margin-top:16px;">æŸ¥è¯¢ç»“æœï¼ˆformats.txtï¼‰</h3>
      <pre id="result">(ç­‰å¾…æŸ¥è¯¢å®Œæˆ...)</pre>
    </div>
  </div>

<script type="module">
  import { unzipSync, strFromU8 } from "https://cdn.jsdelivr.net/npm/fflate@0.8.2/esm/browser.js";

  const WORKER_BASE = "https://ytdlp-actions-panel-api.yswwsy.workers.dev";

  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function parseYouTubeId(input){
    try{
      const u = new URL(input);
      const v = u.searchParams.get("v");
      if (v) return v;
      if (u.hostname.includes("youtu.be")) {
        const id = u.pathname.split("/").filter(Boolean)[0];
        if (id) return id;
      }
      const parts = u.pathname.split("/").filter(Boolean);
      const shortsIdx = parts.indexOf("shorts");
      if (shortsIdx >= 0 && parts[shortsIdx+1]) return parts[shortsIdx+1];
      return null;
    } catch {
      return null;
    }
  }

  function ytThumbFromId(id){
    return id ? `https://i.ytimg.com/vi/${id}/hqdefault.jpg` : null;
  }

  function shieldDownloadBadge(resolution){
    const label = "YouTube";
    const message = resolution ? `ä¸‹è½½zipï¼ˆç»Workerï¼‰ ğŸï¸ ${resolution}` : `ä¸‹è½½zipï¼ˆç»Workerï¼‰`;
    const url = new URL("https://img.shields.io/static/v1");
    url.searchParams.set("label", label);
    url.searchParams.set("message", message);
    url.searchParams.set("color", "FF0000");
    url.searchParams.set("style", "plastic");
    url.searchParams.set("logo", "youtube");
    url.searchParams.set("logoColor", "white");
    return url.toString();
  }

  function renderSteps(jobsJson){
    const jobs = jobsJson.jobs || [];
    let html = `<div class="table-wrap"><table><thead><tr><th>Job</th><th>Step</th><th>Status</th><th>Conclusion</th></tr></thead><tbody>`;
    for(const job of jobs){
      for(const s of (job.steps || [])){
        html += `<tr>
          <td>${esc(job.name || "")}</td>
          <td>${esc(s.name || "")}</td>
          <td>${esc(s.status || "")}</td>
          <td>${esc(s.conclusion || "")}</td>
        </tr>`;
      }
    }
    html += "</tbody></table></div>";
    $("steps").innerHTML = html;
  }

  function humanBytes(n){
    if (n == null) return "";
    const units = ["B","KB","MB","GB"];
    let i = 0, x = Number(n);
    while (x >= 1024 && i < units.length-1){ x/=1024; i++; }
    return `${x.toFixed(i===0?0:2)} ${units[i]}`;
  }

  async function fetchJSON(path){
    const r = await fetch(WORKER_BASE + path, { credentials: "include" });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  async function postJSON(path, body){
    const r = await fetch(WORKER_BASE + path, {
      method:"POST",
      credentials: "include",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  async function downloadZipAndExtractText(runId, artifactName, targetSuffix){
    const zipResp = await fetch(
      WORKER_BASE + `/artifact-zip?run_id=${encodeURIComponent(runId)}&name=${encodeURIComponent(artifactName)}`,
      { credentials:"include" }
    );
    if(!zipResp.ok){
      throw new Error(await zipResp.text());
    }
    const buf = await zipResp.arrayBuffer();
    const files = unzipSync(new Uint8Array(buf));
    const key = Object.keys(files).find(k => k.endsWith(targetSuffix));
    if(!key) throw new Error(`zip ä¸­æœªæ‰¾åˆ° ${targetSuffix}`);
    return strFromU8(files[key]);
  }

  async function tryLoadMeta(runId, requestId, artifactsJson){
    const metaName = `meta-${requestId}`;
    const exists = (artifactsJson.artifacts || []).some(a => a.name === metaName);
    if(!exists) return null;
    const txt = await downloadZipAndExtractText(runId, metaName, "meta.json");
    return JSON.parse(txt);
  }

  function renderArtifacts(runId, requestId, artifactsJson, meta, thumbUrlFallback){
    const arts = artifactsJson.artifacts || [];
    if(!arts.length){
      $("artifacts").innerHTML = "<div class='muted'>ï¼ˆè¯¥ run æ²¡æœ‰ artifactsï¼‰</div>";
      return;
    }

    const queryName = `query-result-${requestId}`;
    const downloadName = `downloaded-videos-${requestId}`;

    const thumbUrl = meta?.thumbnail || thumbUrlFallback || "";

    let html = `<div class="table-wrap"><table>
      <thead><tr><th>é¢„è§ˆ</th><th>Name</th><th>Size</th><th>æ“ä½œ</th></tr></thead><tbody>`;

    for(const a of arts){
      const name = a.name;
      const size = a.size_in_bytes;

      const proxyZip = `${WORKER_BASE}/artifact-zip?run_id=${encodeURIComponent(runId)}&name=${encodeURIComponent(name)}`;
      const ghUi = `https://github.com/pdahd/ytdlp-actions-panel/actions/runs/${encodeURIComponent(runId)}/artifacts/${encodeURIComponent(a.id)}`;

      const badges = [];
      if(name === queryName) badges.push(`<span class="pill">query</span>`);
      if(name === downloadName) badges.push(`<span class="pill">download</span>`);

      let workerDownloadHtml = `<a href="${proxyZip}">ä¸‹è½½zipï¼ˆç»Workerï¼‰</a>`;
      if(name === downloadName){
        const res = meta?.selected?.resolution || null;
        const badgeUrl = shieldDownloadBadge(res);
        workerDownloadHtml = `<a href="${proxyZip}">
          <img class="badge-img" src="${badgeUrl}" alt="download badge">
        </a>`;
      }

      html += `<tr>
        <td>${thumbUrl ? `<img class="thumb" src="${esc(thumbUrl)}" alt="thumb" loading="lazy">` : ""}</td>
        <td>${esc(name)} ${badges.join(" ")}</td>
        <td>${esc(humanBytes(size))}</td>
        <td>
          ${workerDownloadHtml}
          &nbsp;|&nbsp;
          <a href="${ghUi}" target="_blank">GitHubé“¾æ¥</a>
        </td>
      </tr>`;
    }

    html += "</tbody></table></div>";
    $("artifacts").innerHTML = html;
  }

  $("f").addEventListener("submit", async (e) => {
    e.preventDefault();
    $("btn").disabled = true;

    $("result").textContent = "(ç­‰å¾…æŸ¥è¯¢å®Œæˆ...)";
    $("steps").innerHTML = "";
    $("runMeta").textContent = "";
    $("artifacts").innerHTML = "";
    $("artNote").textContent = "ï¼ˆè¿è¡Œå®Œæˆåè‡ªåŠ¨åŠ è½½ï¼‰";
    $("status").textContent = "æ­£åœ¨è§¦å‘å·¥ä½œæµ...";

    const fd = new FormData(e.target);
    const request_id = uuid();

    const inputs = {
      request_id,
      action_type: fd.get("action_type"),
      video_link: fd.get("video_link"),
      video_format: fd.get("video_format") || "",
      enable_sections: fd.get("enable_sections") || "å¦",
      start_time: fd.get("start_time") || "",
      end_time: fd.get("end_time") || "",
    };

    if(inputs.action_type === "ä¸‹è½½" && !inputs.video_format){
      alert("ä¸‹è½½æ¨¡å¼éœ€è¦å¡«å†™ è§†é¢‘æ ¼å¼ä»£ç ");
      $("btn").disabled = false;
      return;
    }

    const vid = parseYouTubeId(inputs.video_link);
    const thumbFallback = ytThumbFromId(vid);

    await postJSON("/dispatch", { ref: "main", inputs });
    $("status").textContent = `å·²è§¦å‘ï¼Œrequest_id=${request_id}ï¼Œæ­£åœ¨å®šä½ run...`;

    let run = null;
    for(let i=0;i<45;i++){
      const res = await fetchJSON(`/resolve?request_id=${encodeURIComponent(request_id)}`);
      if(res.found){ run = res.run; break; }
      await sleep(1000);
    }
    if(!run){
      $("status").textContent = "æœªèƒ½å®šä½åˆ° runï¼ˆå¯èƒ½ GitHub å»¶è¿Ÿï¼‰ã€‚è¯·ç¨åé‡è¯•æˆ–å» Actions é¡µé¢æŸ¥çœ‹ã€‚";
      $("btn").disabled = false;
      return;
    }

    const runId = run.id;
    $("runMeta").innerHTML = `run_id=${runId} | <a href="${run.html_url}" target="_blank">æ‰“å¼€ GitHub è¿è¡Œé¡µé¢</a>`;
    $("status").textContent = "è¿è¡Œä¸­...";

    let runInfo = null;
    while(true){
      runInfo = await fetchJSON(`/run?run_id=${runId}`);
      const jobs = await fetchJSON(`/jobs?run_id=${runId}`);
      renderSteps(jobs);

      const st = `${runInfo.status}${runInfo.conclusion ? " / " + runInfo.conclusion : ""}`;
      $("status").textContent = `çŠ¶æ€ï¼š${st}`;

      if(runInfo.status === "completed") break;
      await sleep(2000);
    }

    let arts = null;
    let meta = null;
    try {
      $("artNote").textContent = "æ­£åœ¨åŠ è½½ artifacts...";
      arts = await fetchJSON(`/artifacts?run_id=${runId}`);
      meta = await tryLoadMeta(runId, request_id, arts);
      renderArtifacts(runId, request_id, arts, meta, thumbFallback);
      $("artNote").textContent = `å…± ${arts.total_count ?? (arts.artifacts||[]).length} ä¸ª artifacts`
        + (meta?.selected?.resolution ? `ï¼›è¯†åˆ«åˆ°åˆ†è¾¨ç‡ï¼š${meta.selected.resolution}` : "");
    } catch (err) {
      $("artNote").textContent = "åŠ è½½ artifacts/meta å¤±è´¥ï¼š" + String(err);
    }

    if(inputs.action_type === "æŸ¥è¯¢" && runInfo.conclusion === "success"){
      const artName = `query-result-${request_id}`;
      $("status").textContent = "æŸ¥è¯¢å·²å®Œæˆï¼Œæ­£åœ¨è·å– formats.txt ...";
      try{
        const txt = await downloadZipAndExtractText(runId, artName, "formats.txt");
        $("result").textContent = txt;
      }catch(e){
        $("result").textContent = "ä¸‹è½½æŸ¥è¯¢ç»“æœ artifact å¤±è´¥ï¼š" + String(e);
      }
    } else {
      $("result").textContent = "ï¼ˆéæŸ¥è¯¢æ¨¡å¼ï¼Œæˆ–è¿è¡Œå¤±è´¥ã€‚è¯·åœ¨ä¸Šæ–¹ Artifacts åŒºä¸‹è½½æˆå“ï¼›æˆ–æ‰“å¼€ GitHub è¿è¡Œé¡µé¢æŸ¥çœ‹æ—¥å¿—ã€‚ï¼‰";
    }

    $("btn").disabled = false;
  });
</script>
</body>
</html>
