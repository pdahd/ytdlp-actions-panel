<!doctype html>
<!-- VERSION: PANEL_UI_v2.2.1_scrollVideoHeaderCenter_debugInstantScroll -->
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>yt-dlp Actions Panel</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg0: #0a1224;
      --bg1: #101b33;
      --bg2: #0a0f1d;

      --app-bg:
        radial-gradient(1200px 700px at 10% -10%, rgba(120,160,255,.28), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(1000px 700px at 50% 110%, rgba(110,255,220,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg2) 100%);

      --text: #eef2ff;
      --muted: rgba(238,242,255,.80);

      --input-bg: rgba(10,14,25,.55);
      --pre-bg: rgba(8,10,18,.60);

      --link: #a9baff;
      --btn: linear-gradient(180deg, #5f7cff 0%, #3f60ff 100%);
      --btn-ghost: rgba(255,255,255,.06);

      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);

      --radius: 18px;
      --radius2: 12px;
      --gap: 12px;

      --ok: #3ddc84;
      --bad: #ff5c7a;
      --warn: #ffd166;
      --skip: rgba(238,242,255,.55);

      --metal-a: #5a6684;
      --metal-b: #1b233a;
      --metal-c: #0b1225;

      --key-a:  #2a3f86;
      --key-b:  #15214d;
      --key-a2: #28407f;
      --key-b2: #141f49;
      --key-border: rgba(255,255,255,.18);

      --key-shadow-out: 0 14px 20px rgba(0,0,0,.50);
      --key-shadow-in:
        inset 0 1px 0 rgba(255,255,255,.20),
        inset 0 -16px 26px rgba(0,0,0,.52);
      --key-radius: 14px;

      --paper-a: #f3e8b0;
      --paper-b: #d8c77a;
      --paper-c: #b59b45;

      --pick-green-a: rgba(32,195,96,.92);
      --pick-green-b: rgba(18,118,62,.95);
      --pick-green-border: rgba(150,255,210,.55);

      --pink-a: rgba(255,105,180,.92);
      --pink-b: rgba(128,20,80,1);
    }

    html{
      height: 100%;
      min-height: 100%;
      background-color: var(--bg0);
      background-image: var(--app-bg);
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    body{
      margin: 0;
      min-height: 100vh;
      background-color: var(--bg0);
      background-image: var(--app-bg);
      background-attachment: fixed;
      background-repeat: no-repeat;
      overscroll-behavior-y: none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", Arial;
      color: var(--text);
    }

    .wrap{ max-width: 1040px; margin: 22px auto; padding: 0 16px; }
    a{ color: var(--link); }
    .muted{ font-size: 13px; color: var(--muted); }
    .hide{ display:none !important; }

    hr{
      border: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
      margin: 14px 0;
    }

    .card{
      position: relative;
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)) padding-box,
        linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.08), rgba(255,255,255,.22)) border-box;
      border: 1px solid transparent;
      box-shadow: var(--shadow);
      padding: 18px;
      overflow: hidden;
      backdrop-filter: blur(10px) saturate(140%);
      -webkit-backdrop-filter: blur(10px) saturate(140%);
    }
    .card::before{
      content:"";
      position:absolute;
      left: -10%;
      right: -10%;
      top: -28px;
      height: 74px;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,.16) 20%,
        rgba(255,255,255,.06) 45%,
        rgba(255,255,255,.14) 70%,
        transparent 100%);
      transform: rotate(-2deg);
      pointer-events:none;
    }

    label{ display:block; font-size: 13px; opacity: .95; margin-bottom: 6px; }

    input, select{
      width: 100%;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.22);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        inset 0 -10px 25px rgba(0,0,0,.22);
    }
    input:focus, select:focus{
      border-color: rgba(160,190,255,.55);
      box-shadow:
        0 0 0 3px rgba(95,124,255,.18),
        inset 0 1px 0 rgba(255,255,255,.10),
        inset 0 -10px 25px rgba(0,0,0,.22);
    }
    input:disabled, select:disabled{ opacity:.55; cursor:not-allowed; }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; min-width:0; }
    .row-between{ display:flex; justify-content: space-between; align-items:center; gap: 10px; flex-wrap:wrap; }

    button{
      padding: 10px 14px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.22);
      background: var(--btn);
      color:#fff;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    button:disabled{ opacity: .6; cursor:not-allowed; }
    .btn-ghost{
      background: var(--btn-ghost);
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(238,242,255,.92);
    }

    pre{
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--pre-bg);
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      overflow:auto;
    }

    .table-wrap{
      width: 100%;
      overflow-x: auto;
      padding: 3px;
      border-radius: 16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.14), transparent 32%),
        linear-gradient(135deg, var(--metal-a) 0%, var(--metal-b) 42%, var(--metal-c) 100%);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow:
        0 12px 22px rgba(0,0,0,.40),
        inset 0 1px 0 rgba(255,255,255,.18),
        inset 0 -1px 0 rgba(0,0,0,.55);
      position: relative;
    }

    table.tbl{
      width:100%;
      min-width: 760px;
      border-collapse: separate;
      border-spacing: 8px;
      border-radius: 13px;
      overflow: hidden;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.12),
        inset 0 -16px 28px rgba(0,0,0,.45);
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(180deg, var(--paper-a), var(--paper-b) 55%, var(--paper-c));
    }

    th, td{
      padding: 10px 10px;
      font-size: 13px;
      vertical-align: top;
      border-radius: var(--key-radius);
    }

    th{
      position: sticky;
      top: 0;
      z-index: 3;
      text-align: left;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow:
        0 14px 22px rgba(0,0,0,.44),
        inset 0 1px 0 rgba(255,255,255,.20),
        inset 0 -14px 20px rgba(0,0,0,.45);
    }

    .thead-runs th{
      background: linear-gradient(180deg, rgba(196,72,58,.92), rgba(78,20,16,1));
    }

    .thead-formats th{
      background: linear-gradient(180deg, var(--pink-a), var(--pink-b));
    }

    .thead-arts th{
      background: linear-gradient(180deg, rgba(165,110,255,.78), rgba(25,33,64,1));
    }

    tbody td{
      position: relative;
      isolation: isolate;
      background:
        radial-gradient(160px 110px at 18% 14%, rgba(255,255,255,.16), transparent 60%),
        linear-gradient(180deg, var(--key-a), var(--key-b));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: var(--key-shadow-out),
        inset 0 1px 0 rgba(255,255,255,.20),
        inset 0 -16px 26px rgba(0,0,0,.52);
      overflow: hidden;
    }
    tbody tr:nth-child(even) td{
      background:
        radial-gradient(160px 110px at 18% 14%, rgba(255,255,255,.16), transparent 60%),
        linear-gradient(180deg, var(--key-a2), var(--key-b2));
    }
    .cell-inner{ position: relative; z-index: 2; }

    .c-success{ color: var(--ok); font-weight: 900; }
    .c-failure{ color: var(--bad); font-weight: 900; }
    .c-cancelled{ color: var(--warn); font-weight: 900; }
    .c-skipped{ color: var(--skip); font-weight: 900; }
    .c-pending{ color: rgba(238,242,255,.60); font-weight: 800; }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:12px;
      opacity:.95;
      margin-left:6px;
      background: rgba(255,255,255,.06);
    }

    .toggle{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      user-select: none;
    }
    .toggle input{ width: 16px; height: 16px; }

    .video-meta{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .video-meta .title{
      font-weight: 900;
      line-height: 1.25;
      margin-bottom: 4px;
    }
    .video-meta .line{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .chip{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: rgba(238,242,255,.86);
    }

    .thumb{
      width: 96px;
      height: 54px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      display:block;
      box-shadow: 0 12px 22px rgba(0,0,0,.55);
      position: relative;
      z-index: 2;
    }

    .badge-img{
      height: 30px;
      max-width: 100%;
      vertical-align: middle;
      filter: drop-shadow(0 14px 20px rgba(0,0,0,.55));
    }

    .dl-btn{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(160px 110px at 18% 14%, rgba(255,255,255,.14), transparent 60%),
        linear-gradient(180deg, #2a355f, #1a2244);
      color: rgba(238,242,255,.95);
      text-decoration: none;
      box-shadow:
        0 12px 18px rgba(0,0,0,.46),
        inset 0 1px 0 rgba(255,255,255,.16),
        inset 0 -14px 22px rgba(0,0,0,.45);
      white-space: nowrap;
    }
    .dl-btn:active{ transform: translateY(1px); }

    .modebar{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 10px 0 8px;
    }
    .modebtn{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
      color: rgba(238,242,255,.92);
      cursor: pointer;
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .modebtn.active{
      background: var(--btn);
      border-color: rgba(255,255,255,.28);
      color: #fff;
    }

    .pick-row{ cursor: pointer; }
    .pick-row td{ transition: transform .06s ease, filter .12s ease; }
    .pick-row:active td{ transform: translateY(1px); }

    tr.picked td{
      background:
        radial-gradient(180px 120px at 18% 14%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(180deg, var(--pick-green-a), var(--pick-green-b)) !important;
      border-color: var(--pick-green-border) !important;
      box-shadow:
        0 16px 24px rgba(0,0,0,.52),
        inset 0 1px 0 rgba(255,255,255,.22),
        inset 0 -16px 26px rgba(0,0,0,.40),
        0 0 0 2px rgba(90,255,190,.18) !important;
      filter: saturate(1.05) brightness(1.05);
    }

    .panel-disabled{
      opacity: .58;
      filter: grayscale(.10);
      pointer-events: none;
    }
    .panel-disabled .muted{ opacity: .95; }

    .disabled-zone{
      position: relative;
      opacity: .60;
      filter: grayscale(.10);
      pointer-events: none;
    }
    .disabled-zone::after{
      content: "ä¸‹è½½ä»»åŠ¡è¿è¡Œä¸­ï¼Œæ ¼å¼åˆ—è¡¨å·²é”å®š";
      position:absolute;
      left: 10px; right: 10px; top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(238,242,255,.92);
      font-weight: 800;
      z-index: 5;
      pointer-events: none;
    }

    .stack{
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
      align-items: start;
    }

    .time-grid{
      display: grid;
      grid-template-columns: minmax(110px, 150px) 1fr 1fr;
      gap: var(--gap);
      align-items: end;
      margin-top: 10px;
    }

    @media (max-width: 720px){
      .wrap{ padding: 0 12px; }
      table.tbl{ min-width: 720px; border-spacing: 7px; }
    }
    @media (max-width: 520px){
      .time-grid{ grid-template-columns: 1fr; }
      .time-grid .time-pair{
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
      }
      table.tbl{ border-spacing: 6px; }
    }
    @media (max-width: 380px){
      .time-grid .time-pair{ grid-template-columns: 1fr; }
      table.tbl{ border-spacing: 5px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="topCard">
      <h2 style="margin:0 0 8px;">yt-dlp Actions æ§åˆ¶å°</h2>
      <div class="muted">æµç¨‹ï¼šç²˜è´´é“¾æ¥ â†’ è§£æ/æŸ¥è¯¢æ ¼å¼ â†’ é€‰æ‹© â†’ æäº¤ä¸‹è½½ â†’ ä¸‹è½½ artifact</div>
      <hr>

      <div class="row" style="align-items:flex-end;">
        <div style="flex: 1 1 520px; min-width: 260px;">
          <label>YouTube è§†é¢‘é“¾æ¥</label>
          <input id="videoLink" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off">
        </div>
        <div class="row">
          <button id="btnQuery" type="button">è§£æ / æŸ¥è¯¢</button>
          <button id="btnReset" type="button" class="btn-ghost">é‡ç½®</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <span id="status" class="muted"></span>
      </div>
    </div>

    <div class="card" style="margin-top:14px;" id="formatsCard">
      <div class="row-between">
        <h3 style="margin:0;">æ ¼å¼åˆ—è¡¨ï¼ˆ720p+ / éŸ³é¢‘100kbps+ï¼‰</h3>
        <div class="row">
          <label class="toggle" title="é»˜è®¤éšè— query/meta ç­‰è°ƒè¯•å·¥ä»¶">
            <input id="showDebugArts" type="checkbox">
            <span class="muted">æ˜¾ç¤ºè°ƒè¯•å·¥ä»¶</span>
          </label>
        </div>
      </div>

      <div id="videoMeta" class="video-meta" style="display:none;"></div>

      <div id="formatsHint" class="muted" style="margin-top:8px;">ï¼ˆå…ˆç‚¹å‡»â€œè§£æ / æŸ¥è¯¢â€è·å–æ ¼å¼åˆ—è¡¨ï¼‰</div>

      <div id="formatsZone" class="hide" style="margin-top:12px;">
        <div class="modebar" role="tablist" aria-label="ä¸‹è½½æ¨¡å¼">
          <div class="modebtn" id="modeV" role="tab" aria-selected="false">åªä¸‹è½½è§†é¢‘</div>
          <div class="modebtn" id="modeA" role="tab" aria-selected="false">åªä¸‹è½½éŸ³é¢‘</div>
          <div class="modebtn active" id="modeVA" role="tab" aria-selected="true">ä¸‹è½½è§†é¢‘ + éŸ³é¢‘</div>
        </div>

        <div class="muted" id="autoPickNote"></div>

        <div class="time-grid">
          <div>
            <label>å¯ç”¨æŒ‡å®šæ—¶é—´æ®µ</label>
            <select id="enableSections">
              <option>å¦</option>
              <option>æ˜¯</option>
            </select>
          </div>

          <div class="time-pair" style="display: contents;">
            <div>
              <label>å¼€å§‹æ—¶é—´</label>
              <input id="startTime" placeholder="mm:ss æˆ– hh:mm:ss">
            </div>
            <div>
              <label>ç»“æŸæ—¶é—´</label>
              <input id="endTime" placeholder="mm:ss æˆ– hh:mm:ss">
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnDownload" type="button">æäº¤ä¸‹è½½ä»»åŠ¡</button>
          <span class="muted" id="downloadTip"></span>
        </div>

        <hr style="margin-top:14px;">

        <div id="pickArea">
          <div class="stack">
            <div id="videoPanel">
              <div class="row-between">
                <b>è§†é¢‘æµï¼ˆå•é€‰ï¼‰</b>
                <span class="muted" id="videoCount"></span>
              </div>
              <div id="videoTable"></div>
            </div>

            <div id="audioPanel">
              <div class="row-between">
                <b>éŸ³é¢‘æµï¼ˆå•é€‰ï¼‰</b>
                <span class="muted" id="audioCount"></span>
              </div>
              <div id="audioTable"></div>
              <div class="muted" style="margin-top:8px;">
                â€œè§†é¢‘+éŸ³é¢‘â€æ¨¡å¼ä¸‹éŸ³é¢‘å°†è‡ªåŠ¨é€‰æ‹©ï¼ˆåˆ—è¡¨ä»…ä¾›æŸ¥çœ‹ï¼‰
              </div>
            </div>
          </div>
        </div>

        <div id="formatsTxtBox" class="hide" style="margin-top:14px;">
          <div class="row-between">
            <b>åŸå§‹ formats.txtï¼ˆä¸´æ—¶å±•ç¤ºï¼‰</b>
            <span class="muted">æœªæ£€æµ‹åˆ° formats.jsonï¼Œè¯·æ›´æ–° workflow</span>
          </div>
          <pre id="formatsTxt">(ç©º)</pre>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;" id="runCard">
      <div class="row-between">
        <div><b>è¿è¡Œä¿¡æ¯</b></div>
        <div class="muted" id="runMeta"></div>
      </div>

      <div id="steps" style="margin-top:12px;"></div>

      <div class="row-between" style="margin-top:14px;" id="artHeader">
        <h3 style="margin:0;">Artifactsï¼ˆæ„å»ºå·¥ä»¶ï¼‰</h3>
        <span class="muted" id="artNote">ï¼ˆä¸‹è½½å®Œæˆåè‡ªåŠ¨åŠ è½½ï¼‰</span>
      </div>

      <div id="artifacts"></div>

      <div id="debugArts" class="hide" style="margin-top:14px;">
        <h3 style="margin:0 0 8px;">è°ƒè¯•å·¥ä»¶ï¼ˆå¯é€‰ï¼‰</h3>
        <div class="muted" style="margin-bottom:8px;">åŒ…å« query/meta ç­‰å·¥ä»¶ä¸‹è½½å…¥å£ï¼ˆé»˜è®¤éšè—ï¼‰</div>
        <div id="debugArtifacts"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { unzipSync, strFromU8 } from "https://cdn.jsdelivr.net/npm/fflate@0.8.2/esm/browser.js";

  const WORKER_BASE = "https://ytdlp-actions-panel-api.yswwsy.workers.dev";

  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function escAttr(s){
    return String(s).replace(/["&<>]/g, c => ({
      '"':"&quot;","&":"&amp;","<":"&lt;",">":"&gt;"
    }[c]));
  }

  function localTimestamp(){
    const d = new Date();
    const p2 = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}${p2(d.getMonth()+1)}${p2(d.getDate())}-${p2(d.getHours())}${p2(d.getMinutes())}${p2(d.getSeconds())}`;
  }

  function buildArtifactZipUrl(runId, artName, dlPrefix){
    const ts = localTimestamp();
    const dlname = `${dlPrefix}-${ts}.zip`;
    const u = new URL(WORKER_BASE + "/artifact-zip");
    u.searchParams.set("run_id", runId);
    u.searchParams.set("name", artName);
    u.searchParams.set("dlname", dlname);
    return u.toString();
  }

  document.addEventListener("click", (e) => {
    const a = e.target.closest("a[data-dl='1']");
    if (!a) return;
    const runId = a.dataset.runid;
    const artName = a.dataset.artname;
    const prefix = a.dataset.prefix || "Artifact";
    if (!runId || !artName) return;
    a.href = buildArtifactZipUrl(runId, artName, prefix);
  }, { capture: true });

  // ========= è‡ªåŠ¨æ»šåŠ¨æ§åˆ¶å™¨ï¼ˆå¯è¢«ç”¨æˆ·æ‰‹åŠ¨æ‰“æ–­ï¼‰ =========
  const scrollCtl = {
    userInteractedAt: 0,
    cooldownMs: 1200,
    timer: null,
    token: 0,
  };

  function markUserInteracted(){
    scrollCtl.userInteractedAt = Date.now();
    if(scrollCtl.timer) clearTimeout(scrollCtl.timer);
    scrollCtl.timer = null;
    scrollCtl.token++;
  }

  for(const ev of ["wheel","touchstart","touchmove","mousedown","keydown"]){
    window.addEventListener(ev, markUserInteracted, { passive: true, capture: true });
  }

  function inCooldown(){
    return (Date.now() - scrollCtl.userInteractedAt) < scrollCtl.cooldownMs;
  }

  function afterTwoFrames(fn){
    requestAnimationFrame(()=> requestAnimationFrame(fn));
  }

  function autoScrollTo(el, {block="start", delay=120} = {}){
    if(!el) return;
    if(inCooldown()) return;

    scrollCtl.token++;
    const myToken = scrollCtl.token;
    if(scrollCtl.timer) clearTimeout(scrollCtl.timer);

    scrollCtl.timer = setTimeout(()=>{
      if(myToken !== scrollCtl.token) return;
      if(inCooldown()) return;

      try{
        el.scrollIntoView({ behavior: "smooth", block });
      } catch {
        const top = el.getBoundingClientRect().top + window.scrollY - 10;
        window.scrollTo({ top: Math.max(0, top), behavior: "smooth" });
      }
    }, delay);
  }

  // æ›´ç²¾ç¡®ï¼šæŠŠæŸå…ƒç´ æ»šåŠ¨åˆ° viewport ä¸­å¿ƒ
  function autoScrollToCenter(el, {delay=0} = {}){
    if(!el) return;
    if(inCooldown()) return;

    scrollCtl.token++;
    const myToken = scrollCtl.token;
    if(scrollCtl.timer) clearTimeout(scrollCtl.timer);

    scrollCtl.timer = setTimeout(()=>{
      if(myToken !== scrollCtl.token) return;
      if(inCooldown()) return;

      const r = el.getBoundingClientRect();
      const targetTop = window.scrollY + r.top + (r.height/2) - (window.innerHeight/2);
      window.scrollTo({ top: Math.max(0, targetTop), behavior: "smooth" });
    }, delay);
  }

  function autoScrollToRunCard(){
    afterTwoFrames(()=> autoScrollTo($("runCard"), {block:"start", delay: 120}));
  }
  function autoScrollToArtifacts(){
    afterTwoFrames(()=> autoScrollTo($("artHeader"), {block:"start", delay: 120}));
  }
  function autoScrollToDebugInstant(){
    afterTwoFrames(()=> autoScrollTo($("debugArts"), {block:"start", delay: 0}));
  }

  // å…³é”®å¾®è°ƒ 1ï¼šæ»šåˆ°â€œè§†é¢‘è¡¨å¤´â€å¹¶å±…ä¸­
  function autoScrollVideoHeaderToCenter(){
    afterTwoFrames(()=>{
      const thead = $("videoTable")?.querySelector("thead");
      if(thead){
        autoScrollToCenter(thead, { delay: 0 });
      } else {
        autoScrollTo($("videoPanel"), { block:"start", delay: 0 });
      }
    });
  }

  function parseYouTubeId(input){
    try{
      const u = new URL(input);
      const v = u.searchParams.get("v");
      if (v) return v;
      if (u.hostname.includes("youtu.be")) {
        const id = u.pathname.split("/").filter(Boolean)[0];
        if (id) return id;
      }
      const parts = u.pathname.split("/").filter(Boolean);
      const shortsIdx = parts.indexOf("shorts");
      if (shortsIdx >= 0 && parts[shortsIdx+1]) return parts[shortsIdx+1];
      return null;
    } catch {
      return null;
    }
  }

  function ytThumbFromId(id){
    return id ? `https://i.ytimg.com/vi/${id}/hqdefault.jpg` : null;
  }

  function shieldDownloadBadge(resolution){
    const label = "YouTube";
    const message = resolution ? `ä¸‹è½½zip ${resolution}` : `ä¸‹è½½zip`;
    const url = new URL("https://img.shields.io/static/v1");
    url.searchParams.set("label", label);
    url.searchParams.set("message", message);
    url.searchParams.set("color", "3f60ff");
    url.searchParams.set("labelColor", "FF0000");
    url.searchParams.set("style", "plastic");
    url.searchParams.set("logo", "youtube");
    url.searchParams.set("logoColor", "white");
    return url.toString();
  }

  async function fetchJSON(path){
    const r = await fetch(WORKER_BASE + path, { credentials: "include" });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  async function postJSON(path, body){
    const r = await fetch(WORKER_BASE + path, {
      method:"POST",
      credentials: "include",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  function clsForConclusion(conc){
    const v = String(conc || "").toLowerCase();
    if (v === "success") return "c-success";
    if (v === "failure") return "c-failure";
    if (v === "cancelled") return "c-cancelled";
    if (v === "skipped") return "c-skipped";
    return "";
  }

  function renderSteps(jobsJson){
    const jobs = jobsJson.jobs || [];
    let html = `<div class="table-wrap"><table class="tbl">
      <thead class="thead-runs"><tr><th>Job</th><th>Step</th><th>Status</th><th>Conclusion</th></tr></thead><tbody>`;

    for(const job of jobs){
      for(const s of (job.steps || [])){
        const status = s.status || "";
        const rawConc = s.conclusion;

        let concText;
        let cls;
        if (rawConc === null || rawConc === undefined || rawConc === "") {
          concText = (status && status !== "completed") ? "â€¦" : "â€”";
          cls = "c-pending";
        } else {
          concText = rawConc;
          cls = clsForConclusion(concText);
        }

        html += `<tr>
          <td><div class="cell-inner">${esc(job.name || "")}</div></td>
          <td><div class="cell-inner">${esc(s.name || "")}</div></td>
          <td><div class="cell-inner">${esc(status)}</div></td>
          <td class="${cls}"><div class="cell-inner">${esc(concText)}</div></td>
        </tr>`;
      }
    }

    html += "</tbody></table></div>";
    $("steps").innerHTML = html;
  }

  function humanBytes(n){
    if (n == null) return "";
    const units = ["B","KB","MB","GB"];
    let i = 0, x = Number(n);
    while (x >= 1024 && i < units.length-1){ x/=1024; i++; }
    return `${x.toFixed(i===0?0:2)} ${units[i]}`;
  }

  async function downloadZipFiles(runId, artifactName){
    const u = new URL(WORKER_BASE + "/artifact-zip");
    u.searchParams.set("run_id", runId);
    u.searchParams.set("name", artifactName);
    const zipResp = await fetch(u.toString(), { credentials:"include" });
    if(!zipResp.ok) throw new Error(await zipResp.text());
    const buf = await zipResp.arrayBuffer();
    return unzipSync(new Uint8Array(buf));
  }

  async function downloadZipAndExtractText(runId, artifactName, targetSuffix){
    const files = await downloadZipFiles(runId, artifactName);
    const key = Object.keys(files).find(k => k.endsWith(targetSuffix));
    if(!key) throw new Error(`zip ä¸­æœªæ‰¾åˆ° ${targetSuffix}`);
    return strFromU8(files[key]);
  }

  function renderVideoMeta(meta){
    const box = $("videoMeta");
    if(!meta){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    const title = meta.title || "(æ— æ ‡é¢˜)";
    const dur = meta.duration == null ? null : (()=>{
      const s = Math.max(0, Math.floor(Number(meta.duration)));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const r = s % 60;
      const p2 = (n)=>String(n).padStart(2,"0");
      return h>0 ? `${h}:${p2(m)}:${p2(r)}` : `${m}:${p2(r)}`;
    })();

    const channel = meta.channel || meta.uploader || "";
    const res = meta?.selected?.resolution || meta?.selected_resolution || "";
    const fmt = meta.requested_format || meta.selected_format || "";

    box.innerHTML = `
      <div class="title">${esc(title)}</div>
      <div class="line">
        ${dur ? `<span class="chip">â± ${esc(dur)}</span>` : ``}
        ${channel ? `<span class="chip">ğŸ“º ${esc(channel)}</span>` : ``}
        ${res ? `<span class="chip">ğŸï¸ ${esc(res)}</span>` : ``}
        ${fmt ? `<span class="chip">fmt=${esc(fmt)}</span>` : ``}
      </div>
    `;
    box.style.display = "block";
  }

  let phase = "idle";

  const state = {
    video_link: "",
    video_id: null,
    thumb_fallback: null,

    query: { request_id:null, run_id:null, html_url:null, formats:null, raw_formats_txt:null },
    download: { request_id:null, run_id:null, html_url:null, meta:null, artifacts:null, runInfo:null },

    pick: { mode:"va", video_id:null, audio_id:null, auto_audio_id:null, auto_audio_reason:"" }
  };

  function setPanelDisabled(id, disabled){
    const el = $(id);
    if(!el) return;
    el.classList.toggle("panel-disabled", !!disabled);
  }

  function setPhase(p){
    phase = p;

    const queried = (p === "queried" || p === "downloading");
    const downloading = (p === "downloading");
    const busy = (p === "querying" || p === "downloading");

    $("btnQuery").disabled = busy || !String($("videoLink").value || "").trim();
    $("btnReset").disabled = busy;

    $("formatsZone").classList.toggle("hide", !queried);
    $("formatsHint").classList.toggle("hide", queried);

    $("pickArea").classList.toggle("disabled-zone", downloading);

    $("enableSections").disabled = !queried || downloading;
    const en = $("enableSections").value === "æ˜¯";
    $("startTime").disabled = !queried || downloading || !en;
    $("endTime").disabled = !queried || downloading || !en;

    $("btnDownload").disabled = !queried || downloading;
    $("downloadTip").textContent = downloading ? "ï¼ˆä¸‹è½½ä»»åŠ¡è¿è¡Œä¸­ï¼Œç­‰å¾…å®Œæˆåå¯å†æ¬¡é€‰æ‹©ï¼‰" : "";

    for(const id of ["modeV","modeA","modeVA"]) {
      $(id).style.pointerEvents = downloading ? "none" : "auto";
      $(id).style.opacity = downloading ? ".55" : "1";
    }
  }

  function resetAllUI(){
    state.video_link = "";
    state.video_id = null;
    state.thumb_fallback = null;

    state.query = { request_id:null, run_id:null, html_url:null, formats:null, raw_formats_txt:null };
    state.download = { request_id:null, run_id:null, html_url:null, meta:null, artifacts:null, runInfo:null };
    state.pick = { mode:"va", video_id:null, audio_id:null, auto_audio_id:null, auto_audio_reason:"" };

    $("status").textContent = "";
    $("runMeta").textContent = "";
    $("steps").innerHTML = "";
    $("artifacts").innerHTML = "";
    $("debugArtifacts").innerHTML = "";
    $("artNote").textContent = "ï¼ˆä¸‹è½½å®Œæˆåè‡ªåŠ¨åŠ è½½ï¼‰";

    $("formatsZone").classList.add("hide");
    $("formatsHint").classList.remove("hide");
    $("formatsTxtBox").classList.add("hide");
    $("formatsTxt").textContent = "(ç©º)";

    $("videoTable").innerHTML = "";
    $("audioTable").innerHTML = "";
    $("videoCount").textContent = "";
    $("audioCount").textContent = "";
    $("autoPickNote").textContent = "";

    $("enableSections").value = "å¦";
    $("startTime").value = "";
    $("endTime").value = "";
    renderVideoMeta(null);

    setMode("va");
    setPhase("idle");
  }

  function normNumber(x){
    if(x == null) return null;
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  function isDrcFormatId(id){
    const s = String(id||"");
    return s.endsWith("-drc") || s.includes("drc");
  }

  function pickBestAudio(audios, preferredId){
    const arr = Array.isArray(audios) ? audios.slice() : [];
    if(preferredId){
      const hit = arr.find(a => String(a.format_id) === String(preferredId));
      if(hit) return { a: hit, reason: `ä¼˜å…ˆé€‰æ‹© ${preferredId}` };
    }
    arr.sort((x,y)=>{
      const dx = isDrcFormatId(x.format_id) ? 1 : 0;
      const dy = isDrcFormatId(y.format_id) ? 1 : 0;
      if(dx !== dy) return dx - dy;
      const ax = normNumber(x.abr) ?? normNumber(x.tbr) ?? 0;
      const ay = normNumber(y.abr) ?? normNumber(y.tbr) ?? 0;
      return ay - ax;
    });
    const best = arr[0] || null;
    return { a: best, reason: best ? `é€‰æ‹©æœ€é«˜ç ç‡éŸ³é¢‘ ${best.format_id}` : "æœªæ‰¾åˆ°å¯ç”¨éŸ³é¢‘" };
  }

  function updateModeNote(){
    const mode = state.pick.mode;

    if(mode === "va"){
      if(!state.pick.video_id){
        $("autoPickNote").textContent = "æ¨¡å¼ï¼šä¸‹è½½è§†é¢‘ + éŸ³é¢‘ï¼ˆè¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æµï¼›æœªé€‰æ‹©æ—¶é»˜è®¤ bestvideo+bestaudioï¼‰";
        return;
      }
      const vId = state.pick.video_id;
      if(state.pick.auto_audio_reason && !state.pick.auto_audio_id){
        $("autoPickNote").textContent = `æ¨¡å¼ï¼šä¸‹è½½è§†é¢‘ + éŸ³é¢‘ï¼ˆæ‚¨é€‰æ‹©äº† ${vId} æµï¼›${state.pick.auto_audio_reason}ï¼‰`;
        return;
      }
      if(state.pick.auto_audio_id){
        $("autoPickNote").textContent =
          `æ¨¡å¼ï¼šä¸‹è½½è§†é¢‘ + éŸ³é¢‘ï¼ˆæ‚¨é€‰æ‹©äº† ${vId} æµï¼›è‡ªåŠ¨æ­é…éŸ³é¢‘ï¼š${state.pick.auto_audio_id}ï¼Œ${state.pick.auto_audio_reason}ï¼‰`;
        return;
      }
      $("autoPickNote").textContent = `æ¨¡å¼ï¼šä¸‹è½½è§†é¢‘ + éŸ³é¢‘ï¼ˆæ‚¨é€‰æ‹©äº† ${vId} æµï¼‰`;
      return;
    }

    if(mode === "v"){
      if(state.pick.video_id){
        $("autoPickNote").textContent = `æ¨¡å¼ï¼šåªä¸‹è½½è§†é¢‘ï¼ˆæ‚¨çš„é€‰æ‹©æ˜¯ ${state.pick.video_id} æµï¼‰`;
      } else {
        $("autoPickNote").textContent = "æ¨¡å¼ï¼šåªä¸‹è½½è§†é¢‘ï¼ˆè¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æµï¼›æœªé€‰æ‹©æ—¶é»˜è®¤ bestvideoï¼‰";
      }
      return;
    }

    if(state.pick.audio_id){
      $("autoPickNote").textContent = `æ¨¡å¼ï¼šåªä¸‹è½½éŸ³é¢‘ï¼ˆæ‚¨çš„é€‰æ‹©æ˜¯ ${state.pick.audio_id} æµï¼‰`;
    } else {
      $("autoPickNote").textContent = "æ¨¡å¼ï¼šåªä¸‹è½½éŸ³é¢‘ï¼ˆè¯·é€‰æ‹©ä¸€ä¸ªéŸ³é¢‘æµï¼›æœªé€‰æ‹©æ—¶é»˜è®¤ bestaudioï¼‰";
    }
  }

  function computeAutoAudio(){
    const formats = state.query.formats;
    if(!formats) return;

    const vids = formats.videos || [];
    const auds = formats.audios || [];
    const v = vids.find(x => String(x.format_id) === String(state.pick.video_id));
    if(!v){
      state.pick.auto_audio_id = null;
      state.pick.auto_audio_reason = "";
      updateModeNote();
      return;
    }

    const hasAudio = String(v.acodec || "none") !== "none";
    if(hasAudio){
      state.pick.auto_audio_id = null;
      state.pick.auto_audio_reason = "è¯¥è§†é¢‘æµè‡ªå¸¦éŸ³é¢‘ï¼ˆæ— éœ€é¢å¤–éŸ³é¢‘ï¼‰";
      updateModeNote();
      return;
    }

    const ext = String(v.ext || "").toLowerCase();
    const vcodec = String(v.vcodec || "").toLowerCase();

    let prefer = null;
    if(ext === "mp4" || vcodec.includes("avc") || vcodec.includes("h264")) prefer = "140";
    else if(ext === "webm" || vcodec.includes("vp9") || vcodec.includes("av01")) prefer = "251";

    let res = pickBestAudio(auds, prefer);
    if(!res.a && prefer){
      res = pickBestAudio(auds, null);
    }

    state.pick.auto_audio_id = res.a ? String(res.a.format_id) : null;
    state.pick.auto_audio_reason = res.reason;
    updateModeNote();
  }

  function setMode(mode){
    state.pick.mode = mode;
    $("modeV").classList.toggle("active", mode==="v");
    $("modeA").classList.toggle("active", mode==="a");
    $("modeVA").classList.toggle("active", mode==="va");

    if(mode === "a"){
      state.pick.video_id = null;
      state.pick.auto_audio_id = null;
      state.pick.auto_audio_reason = "";
    } else if(mode === "v"){
      state.pick.audio_id = null;
      state.pick.auto_audio_id = null;
      state.pick.auto_audio_reason = "";
    } else {
      state.pick.audio_id = null;
    }

    const downloading = (phase === "downloading");
    setPanelDisabled("videoPanel", mode === "a" || downloading);
    setPanelDisabled("audioPanel", mode !== "a" || downloading);

    if(mode === "va" && state.pick.video_id) computeAutoAudio();

    rerenderPickTables();
  }

  $("modeV").addEventListener("click", ()=> setMode("v"));
  $("modeA").addEventListener("click", ()=> setMode("a"));
  $("modeVA").addEventListener("click", ()=> setMode("va"));

  $("enableSections").addEventListener("change", ()=> setPhase(phase));
  $("videoLink").addEventListener("input", ()=>{
    const v = String($("videoLink").value||"").trim();
    $("btnQuery").disabled = (phase==="querying" || phase==="downloading") || !v;
  });

  $("btnReset").addEventListener("click", ()=>{
    if(phase==="querying" || phase==="downloading") return;
    $("videoLink").value = "";
    resetAllUI();
  });

  function renderFormatsTable(type, rows, pickedId){
    const isVideo = (type === "video");
    const cols = isVideo
      ? ["ID","EXT","åˆ†è¾¨ç‡","FPS","åè®®","ç ç‡","VCODEC","ACODEC","å¤‡æ³¨"]
      : ["ID","EXT","ç ç‡(abr)","åè®®","ACODEC","å¤‡æ³¨"];

    let html = `<div class="table-wrap"><table class="tbl">
      <thead class="thead-formats"><tr>${cols.map(c=>`<th>${esc(c)}</th>`).join("")}</tr></thead><tbody>`;

    for(const r of (rows || [])){
      const id = String(r.format_id ?? "");
      const picked = (String(pickedId||"") === id);

      const protocol = r.protocol || r.proto || "";
      const note = r.note || r.format_note || r.more_info || "";
      const tbr = normNumber(r.tbr);
      const abr = normNumber(r.abr);

      const bitrateText = isVideo
        ? (tbr != null ? `${Math.round(tbr)}k` : "")
        : (abr != null ? `${Math.round(abr)}k` : (tbr != null ? `${Math.round(tbr)}k` : ""));

      const res = (()=>{
        const h = normNumber(r.height);
        const w = normNumber(r.width);
        if(h && w) return `${h}p (${w}x${h})`;
        if(h) return `${h}p`;
        const s = String(r.resolution || r.res || "");
        return s || "";
      })();

      const fps = normNumber(r.fps);
      const vcodec = r.vcodec || "";
      const acodec = r.acodec || "";
      const ext = r.ext || "";

      const trCls = ["pick-row", picked ? "picked" : ""].filter(Boolean).join(" ");

      const cells = isVideo ? [
        id, ext, res, (fps!=null?fps:""), protocol, bitrateText, vcodec, acodec, note
      ] : [
        id, ext, bitrateText, protocol, acodec, note
      ];

      html += `<tr class="${escAttr(trCls)}" data-id="${escAttr(id)}" data-type="${escAttr(type)}">
        ${cells.map(v=>`<td><div class="cell-inner">${esc(v ?? "")}</div></td>`).join("")}
      </tr>`;
    }

    html += "</tbody></table></div>";
    return html;
  }

  function rerenderPickTables(){
    const formats = state.query.formats;
    if(!formats) return;

    const vids = formats.videos || [];
    const auds = formats.audios || [];

    $("videoCount").textContent = `${vids.length} æ¡`;
    $("audioCount").textContent = `${auds.length} æ¡`;

    $("videoTable").innerHTML = renderFormatsTable("video", vids, state.pick.video_id);
    $("audioTable").innerHTML = renderFormatsTable("audio", auds, state.pick.audio_id);

    for(const tr of $("videoTable").querySelectorAll("tr.pick-row")){
      tr.addEventListener("click", ()=>{
        if(phase === "downloading") return;
        if(state.pick.mode === "a") return;
        const id = tr.dataset.id;
        state.pick.video_id = id;
        if(state.pick.mode === "va") computeAutoAudio();
        updateModeNote();
        rerenderPickTables();
      });
    }

    for(const tr of $("audioTable").querySelectorAll("tr.pick-row")){
      tr.addEventListener("click", ()=>{
        if(phase === "downloading") return;
        if(state.pick.mode !== "a") return;
        const id = tr.dataset.id;
        state.pick.audio_id = id;
        updateModeNote();
        rerenderPickTables();
      });
    }

    if(state.pick.mode === "va"){
      if(state.pick.video_id) computeAutoAudio();
      else updateModeNote();
    } else {
      updateModeNote();
    }
  }

  function buildFormatSpecForDownload(){
    const mode = state.pick.mode;

    if(mode === "va"){
      if(!state.pick.video_id) return "bestvideo+bestaudio";
      const v = state.query.formats?.videos?.find(x => String(x.format_id) === String(state.pick.video_id));
      if(!v) return "bestvideo+bestaudio";
      const hasAudio = String(v.acodec || "none") !== "none";
      if(hasAudio) return String(v.format_id);
      const aId = state.pick.auto_audio_id;
      if(aId) return `${v.format_id}+${aId}`;
      return "bestvideo+bestaudio";
    }

    if(mode === "v"){
      if(!state.pick.video_id) return "bestvideo";
      return String(state.pick.video_id);
    }

    if(!state.pick.audio_id) return "bestaudio";
    return String(state.pick.audio_id);
  }

  function cleanFormatsTxt(txt){
    const lines = String(txt||"").split(/\r?\n/);
    let idx = lines.findIndex(l => l.startsWith("ID") && l.includes("EXT") && l.includes("RESOLUTION"));
    if(idx < 0) idx = lines.findIndex(l => l.startsWith("ID") && l.includes("EXT"));
    if(idx < 0) return txt;
    return lines.slice(idx).join("\n").trim();
  }

  async function dispatchWorkflow(inputs){
    return await postJSON("/dispatch", { ref: "main", inputs });
  }

  async function resolveRun(request_id){
    for(let i=0;i<45;i++){
      const res = await fetchJSON(`/resolve?request_id=${encodeURIComponent(request_id)}`);
      if(res.found) return res.run;
      await sleep(1000);
    }
    return null;
  }

  async function pollRunToEnd(runId, onTick){
    while(true){
      const runInfo = await fetchJSON(`/run?run_id=${runId}`);
      const jobs = await fetchJSON(`/jobs?run_id=${runId}`);
      onTick?.(runInfo, jobs);
      if(runInfo.status === "completed") return runInfo;
      await sleep(2000);
    }
  }

  function renderRunMeta(){
    const q = state.query;
    const d = state.download;

    let html = "";
    if(q.run_id){
      html += `æŸ¥è¯¢ run_id=${esc(q.run_id)} `;
      if(q.html_url) html += `| <a href="${escAttr(q.html_url)}" target="_blank">æ‰“å¼€æŸ¥è¯¢è¿è¡Œ</a>`;
      html += "<br>";
    }
    if(d.run_id){
      html += `ä¸‹è½½ run_id=${esc(d.run_id)} `;
      if(d.html_url) html += `| <a href="${escAttr(d.html_url)}" target="_blank">æ‰“å¼€ä¸‹è½½è¿è¡Œ</a>`;
    }
    $("runMeta").innerHTML = html || "";
  }

  function renderArtifactsTable(runId, artifactsJson){
    const artsAll = artifactsJson.artifacts || [];
    const arts = artsAll.filter(a => String(a.name || "").startsWith("downloaded-videos-"));

    if(!arts.length){
      return "<div class='muted'>ï¼ˆæ²¡æœ‰å¯ä¸‹è½½çš„æˆå“ artifactsï¼‰</div>";
    }

    const thumbUrl = state.download.meta?.thumbnail || state.query.formats?.video?.thumbnail || state.thumb_fallback || "";

    let html = `<div class="table-wrap"><table class="tbl">
      <thead class="thead-arts"><tr><th>é¢„è§ˆ</th><th>Name</th><th>Size</th><th>ä¸‹è½½</th></tr></thead><tbody>`;

    for(const a of arts){
      const name = a.name;
      const size = a.size_in_bytes;

      const baseHref = `${WORKER_BASE}/artifact-zip?run_id=${encodeURIComponent(runId)}&name=${encodeURIComponent(name)}`;
      const res = state.download.meta?.selected?.resolution || null;

      const downloadHtml = `
        <div class="cell-inner">
          <a data-dl="1" data-runid="${escAttr(runId)}" data-artname="${escAttr(name)}" data-prefix="YouTube"
             href="${escAttr(baseHref)}">
            <img class="badge-img" src="${escAttr(shieldDownloadBadge(res))}" alt="download badge">
          </a>
        </div>`;

      html += `<tr>
        <td><div class="cell-inner">${thumbUrl ? `<img class="thumb" src="${escAttr(thumbUrl)}" alt="thumb" loading="lazy">` : ""}</div></td>
        <td><div class="cell-inner"><div style="font-weight:900;">${esc(name)}</div></div></td>
        <td><div class="cell-inner">${esc(humanBytes(size))}</div></td>
        <td>${downloadHtml}</td>
      </tr>`;
    }

    html += "</tbody></table></div>";
    return html;
  }

  async function tryLoadMetaFromRun(runId, requestId, artifactsJson){
    const metaName = `meta-${requestId}`;
    const exists = (artifactsJson.artifacts || []).some(a => a.name === metaName);
    if(!exists) return null;
    const txt = await downloadZipAndExtractText(runId, metaName, "meta.json");
    return JSON.parse(txt);
  }

  async function renderDebugArtifactsPanel(){
    const parts = [];

    if(state.query.run_id && state.query.request_id){
      try{
        const arts = await fetchJSON(`/artifacts?run_id=${state.query.run_id}`);
        const qname = `query-result-${state.query.request_id}`;
        const exists = (arts.artifacts||[]).some(a => a.name === qname);
        if(exists){
          parts.push(`
            <div class="muted" style="margin:6px 0 8px;"><b>Query å·¥ä»¶</b></div>
            <a class="dl-btn" data-dl="1" data-runid="${escAttr(state.query.run_id)}" data-artname="${escAttr(qname)}" data-prefix="Formats"
               href="${escAttr(WORKER_BASE + "/artifact-zip?run_id="+encodeURIComponent(state.query.run_id)+"&name="+encodeURIComponent(qname))}">
               â¬‡ ä¸‹è½½ query-result zip
            </a>
          `);
        } else {
          parts.push(`<div class="muted">ï¼ˆæœªæ‰¾åˆ° query å·¥ä»¶ï¼š${esc(qname)}ï¼‰</div>`);
        }
      } catch(e){
        parts.push(`<div class="muted">åŠ è½½ query è°ƒè¯•å·¥ä»¶å¤±è´¥ï¼š${esc(String(e))}</div>`);
      }
    }

    if(state.download.run_id && state.download.request_id){
      try{
        const arts = state.download.artifacts || await fetchJSON(`/artifacts?run_id=${state.download.run_id}`);
        const mname = `meta-${state.download.request_id}`;
        const exists = (arts.artifacts||[]).some(a => a.name === mname);
        if(exists){
          parts.push(`
            <div class="muted" style="margin:14px 0 8px;"><b>meta å·¥ä»¶</b></div>
            <a class="dl-btn" data-dl="1" data-runid="${escAttr(state.download.run_id)}" data-artname="${escAttr(mname)}" data-prefix="Meta"
               href="${escAttr(WORKER_BASE + "/artifact-zip?run_id="+encodeURIComponent(state.download.run_id)+"&name="+encodeURIComponent(mname))}">
               â¬‡ ä¸‹è½½ meta zip
            </a>
          `);
        }
      } catch(e){
        parts.push(`<div class="muted">åŠ è½½ meta è°ƒè¯•å·¥ä»¶å¤±è´¥ï¼š${esc(String(e))}</div>`);
      }
    }

    $("debugArtifacts").innerHTML = parts.join("<div style='height:10px;'></div>") || "<div class='muted'>(æš‚æ— )</div>";
  }

  function minDim720Guard(v){
    const w = normNumber(v.width);
    const h = normNumber(v.height);
    if(w != null && h != null){
      return Math.min(w, h) >= 720;
    }
    return (h != null ? h >= 720 : true);
  }

  $("showDebugArts").addEventListener("change", async ()=>{
    const on = $("showDebugArts").checked;
    $("debugArts").classList.toggle("hide", !on);

    if(on){
      // å¾®è°ƒ 2ï¼šä¸ç­‰å¾…ç½‘ç»œï¼Œå…ˆç«‹åˆ»æ»šåˆ°åº•éƒ¨ï¼ˆdelay=0ï¼‰
      autoScrollToDebugInstant();

      await renderDebugArtifactsPanel();

      // è‹¥ç¡®å®æœ‰ä¸‹è½½æŒ‰é’®ä¸”ç”¨æˆ·æœªä»‹å…¥ï¼Œå¯å†å¯¹é½ä¸€æ¬¡ï¼ˆåŒæ · delay=0ï¼‰
      const hasLink = !!$("debugArtifacts").querySelector("a.dl-btn, a[data-dl='1']");
      if(hasLink && !inCooldown()){
        autoScrollToDebugInstant();
      }
    }
  });

  async function doQuery(){
    const link = String($("videoLink").value||"").trim();
    if(!link) return;

    const debugOn = $("showDebugArts").checked;
    resetAllUI();
    $("showDebugArts").checked = debugOn;
    $("debugArts").classList.toggle("hide", !debugOn);

    state.video_link = link;
    state.video_id = parseYouTubeId(link);
    state.thumb_fallback = ytThumbFromId(state.video_id);

    setPhase("querying");
    $("status").textContent = "æ­£åœ¨è§¦å‘æŸ¥è¯¢å·¥ä½œæµ...";
    $("videoLink").disabled = true;

    autoScrollToRunCard();

    const request_id = uuid();
    state.query.request_id = request_id;

    await dispatchWorkflow({
      request_id,
      action_type: "æŸ¥è¯¢",
      video_link: link,
      video_format: "",
      enable_sections: "å¦",
      start_time: "",
      end_time: "",
    });

    $("status").textContent = `å·²è§¦å‘æŸ¥è¯¢ï¼Œrequest_id=${request_id}ï¼Œæ­£åœ¨å®šä½ run...`;

    const run = await resolveRun(request_id);
    if(!run){
      $("status").textContent = "æœªèƒ½å®šä½åˆ°æŸ¥è¯¢ runï¼ˆå¯èƒ½ GitHub å»¶è¿Ÿï¼‰ã€‚è¯·ç¨åé‡è¯•æˆ–å» Actions é¡µé¢æŸ¥çœ‹ã€‚";
      $("videoLink").disabled = false;
      setPhase("idle");
      return;
    }

    state.query.run_id = run.id;
    state.query.html_url = run.html_url;
    renderRunMeta();

    autoScrollToRunCard();

    $("status").textContent = "æŸ¥è¯¢è¿è¡Œä¸­...";
    await pollRunToEnd(run.id, (runInfo, jobs)=>{
      renderSteps(jobs);
      const st = `${runInfo.status}${runInfo.conclusion ? " / " + runInfo.conclusion : ""}`;
      $("status").textContent = `æŸ¥è¯¢çŠ¶æ€ï¼š${st}`;
    });

    try{
      $("status").textContent = "æŸ¥è¯¢å·²å®Œæˆï¼Œæ­£åœ¨åŠ è½½æ ¼å¼åˆ—è¡¨...";
      const qname = `query-result-${state.query.request_id}`;

      let formatsObj = null;
      try{
        const files = await downloadZipFiles(state.query.run_id, qname);
        const jsonKey = Object.keys(files).find(k => k.endsWith("formats.json"));
        if(jsonKey){
          const jsonTxt = strFromU8(files[jsonKey]);
          formatsObj = JSON.parse(jsonTxt);
        } else {
          const txtKey = Object.keys(files).find(k => k.endsWith("formats.txt"));
          if(txtKey){
            const raw = strFromU8(files[txtKey]);
            state.query.raw_formats_txt = cleanFormatsTxt(raw);
          }
        }
      } catch(e){
        throw e;
      }

      if(!formatsObj){
        $("formatsZone").classList.remove("hide");
        $("formatsTxtBox").classList.toggle("hide", !state.query.raw_formats_txt);
        if(state.query.raw_formats_txt) $("formatsTxt").textContent = state.query.raw_formats_txt;
        $("status").textContent = "æœªæ‰¾åˆ° formats.jsonï¼ˆå½“å‰ workflow å¯èƒ½å°šæœªå‡çº§ï¼‰ã€‚è¯·æ›´æ–° ytdlp.yml åå†ä½¿ç”¨åˆ—è¡¨é€‰æ‹©ã€‚";
        setPhase("queried");
        $("videoLink").disabled = false;
        return;
      }

      const videoMeta = formatsObj.video || formatsObj.meta || {};
      let vids = formatsObj.videos || [];
      const auds = formatsObj.audios || [];

      vids = vids.filter(minDim720Guard);

      state.query.formats = { video: videoMeta, videos: vids, audios: auds };

      renderVideoMeta({
        title: videoMeta.title,
        duration: videoMeta.duration,
        uploader: videoMeta.uploader,
        channel: videoMeta.channel,
        thumbnail: videoMeta.thumbnail || state.thumb_fallback,
      });

      $("formatsZone").classList.remove("hide");
      $("formatsTxtBox").classList.add("hide");

      setMode("va");
      rerenderPickTables();

      $("status").textContent = `æ ¼å¼åˆ—è¡¨å·²åŠ è½½ï¼šè§†é¢‘ ${vids.length} æ¡ / éŸ³é¢‘ ${auds.length} æ¡ã€‚è¯·é€‰æ‹©åæäº¤ä¸‹è½½ä»»åŠ¡ã€‚`;

      setPhase("queried");
      $("videoLink").disabled = false;

      if($("showDebugArts").checked){
        await renderDebugArtifactsPanel();
      }

      // å¾®è°ƒ 1ï¼šæ»šåˆ°â€œè§†é¢‘è¡¨å¤´â€å¹¶å±…ä¸­
      autoScrollVideoHeaderToCenter();
    } catch(err){
      $("status").textContent = "åŠ è½½æ ¼å¼åˆ—è¡¨å¤±è´¥ï¼š" + String(err);
      setPhase("idle");
      $("videoLink").disabled = false;
    }
  }

  $("btnQuery").addEventListener("click", async ()=>{
    try{ await doQuery(); } catch(e){
      $("status").textContent = String(e);
      setPhase("idle");
      $("videoLink").disabled = false;
    }
  });

  async function doDownload(){
    if(!state.query.formats){
      alert("è¯·å…ˆè§£æ/æŸ¥è¯¢ï¼Œè·å¾—æ ¼å¼åˆ—è¡¨åå†ä¸‹è½½");
      return;
    }

    setPhase("downloading");
    setPanelDisabled("videoPanel", true);
    setPanelDisabled("audioPanel", true);

    $("status").textContent = "æ­£åœ¨è§¦å‘ä¸‹è½½å·¥ä½œæµ...";
    autoScrollToRunCard();

    const req = uuid();
    state.download.request_id = req;

    const formatSpec = buildFormatSpecForDownload();

    const inputs = {
      request_id: req,
      action_type: "ä¸‹è½½",
      video_link: state.video_link,
      video_format: formatSpec,
      enable_sections: $("enableSections").value,
      start_time: $("startTime").value || "",
      end_time: $("endTime").value || "",
    };

    await dispatchWorkflow(inputs);
    $("status").textContent = `å·²è§¦å‘ä¸‹è½½ï¼Œrequest_id=${req}ï¼Œæ­£åœ¨å®šä½ run...`;

    const run = await resolveRun(req);
    if(!run){
      $("status").textContent = "æœªèƒ½å®šä½åˆ°ä¸‹è½½ runï¼ˆå¯èƒ½ GitHub å»¶è¿Ÿï¼‰ã€‚è¯·ç¨åé‡è¯•æˆ–å» Actions é¡µé¢æŸ¥çœ‹ã€‚";
      setPhase("queried");
      setMode(state.pick.mode);
      return;
    }

    state.download.run_id = run.id;
    state.download.html_url = run.html_url;
    renderRunMeta();

    autoScrollToRunCard();

    $("status").textContent = `ä¸‹è½½è¿è¡Œä¸­ï¼ˆfmt=${formatSpec}ï¼‰...`;

    const runInfo = await pollRunToEnd(run.id, (ri, jobs)=>{
      renderSteps(jobs);
      const st = `${ri.status}${ri.conclusion ? " / " + ri.conclusion : ""}`;
      $("status").textContent = `ä¸‹è½½çŠ¶æ€ï¼š${st}ï¼ˆfmt=${formatSpec}ï¼‰`;
    });
    state.download.runInfo = runInfo;

    try{
      $("artNote").textContent = "æ­£åœ¨åŠ è½½ artifacts...";
      const arts = await fetchJSON(`/artifacts?run_id=${state.download.run_id}`);
      state.download.artifacts = arts;

      const meta = await tryLoadMetaFromRun(state.download.run_id, state.download.request_id, arts);
      state.download.meta = meta;
      if(meta){
        renderVideoMeta(meta);
      } else if(state.query.formats?.video){
        renderVideoMeta({
          title: state.query.formats.video.title,
          duration: state.query.formats.video.duration,
          uploader: state.query.formats.video.uploader,
          channel: state.query.formats.video.channel,
          thumbnail: state.query.formats.video.thumbnail || state.thumb_fallback,
        });
      }

      $("artifacts").innerHTML = renderArtifactsTable(state.download.run_id, arts);
      $("artNote").textContent = `å…± ${arts.total_count ?? (arts.artifacts||[]).length} ä¸ª artifacts`;

      if($("showDebugArts").checked){
        await renderDebugArtifactsPanel();
      }

      autoScrollToArtifacts();
    } catch(e){
      $("artNote").textContent = "åŠ è½½ artifacts å¤±è´¥ï¼š" + String(e);
    }

    const conc = (runInfo.conclusion || "").toLowerCase();
    if(conc === "success"){
      $("status").textContent = "ä¸‹è½½å·²å®Œæˆï¼šè¯·åœ¨ Artifacts åŒºä¸‹è½½æˆå“ zipã€‚";
    } else {
      $("status").textContent = `ä¸‹è½½ç»“æŸï¼š${runInfo.conclusion || "unknown"}ï¼ˆå¯æ‰“å¼€è¿è¡Œé¡µé¢æŸ¥çœ‹æ—¥å¿—ï¼‰`;
    }

    setPhase("queried");
    setMode(state.pick.mode);
  }

  $("btnDownload").addEventListener("click", async ()=>{
    try{ await doDownload(); } catch(e){
      $("status").textContent = "æäº¤/è¿è¡Œä¸‹è½½å¤±è´¥ï¼š" + String(e);
      setPhase("queried");
      setMode(state.pick.mode);
    }
  });

  resetAllUI();
</script>
</body>
</html>
