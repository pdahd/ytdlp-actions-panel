<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>yt-dlp Actions Panel</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg: #0b1020;
      --fg: #e8ecff;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --border2: rgba(255,255,255,.18);
      --muted: rgba(232,236,255,.80);
      --input-bg: rgba(0,0,0,.25);
      --pre-bg: rgba(0,0,0,.35);
      --btn: #4b6bff;
      --link: #9db2ff;
      --gap: 12px;
      --radius: 16px;
      --radius2: 12px;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", Arial;
      background: var(--bg);
      color: var(--fg);
    }

    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
    }

    .muted { opacity: .85; font-size: 13px; color: var(--muted); }
    a { color: var(--link); }
    hr { border: 0; border-top: 1px solid var(--border); margin: 14px 0; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .grid > * { min-width: 0; }
    .full { grid-column: 1 / -1; min-width: 0; }

    label { display:block; font-size: 13px; opacity:.92; margin-bottom:6px; }

    input, select {
      width: 100%;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border2);
      background: var(--input-bg);
      color: var(--fg);
      outline: none;
    }

    .time-grid{
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: minmax(110px, 150px) 1fr 1fr;
      gap: var(--gap);
      align-items: end;
    }
    .time-grid > * { min-width: 0; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; min-width:0; }

    button {
      padding: 10px 14px;
      border-radius: var(--radius2);
      border: 1px solid var(--border2);
      background: var(--btn);
      color: #fff;
      cursor: pointer;
      max-width: 100%;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--pre-bg);
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      overflow: auto;
    }

    .table-wrap{
      width: 100%;
      overflow-x: auto;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(0,0,0,.12);
    }

    table{ width:100%; border-collapse: collapse; min-width: 720px; }
    td, th{ border-bottom: 1px solid rgba(255,255,255,.10); padding: 8px; font-size: 13px; vertical-align: top; }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      font-size:12px;
      opacity:.9;
      margin-left:6px;
    }

    .thumb{
      width: 96px;
      height: 54px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      display:block;
    }

    .badge-img{
      height: 26px;
      max-width: 100%;
      vertical-align: middle;
    }

    @media (max-width: 720px){
      .wrap{ padding: 0 12px; }
      .grid{ grid-template-columns: 1fr; }
    }

    @media (max-width: 520px){
      .time-grid{ grid-template-columns: 1fr; }
      .time-grid .time-pair{
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
      }
      .time-grid .time-pair > * { min-width: 0; }
    }

    @media (max-width: 380px){
      .time-grid .time-pair{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px;">yt-dlp Actions æ§åˆ¶å°</h2>
      <div class="muted">ç½‘é¡µè¡¨å• â†’ Cloudflare Worker â†’ workflow_dispatch â†’ è½®è¯¢ run/jobs â†’ å±•ç¤ºç»“æœ + artifacts ä¸‹è½½</div>

      <hr>

      <form id="f">
        <div class="grid">
          <div>
            <label>æ“ä½œç±»å‹</label>
            <select name="action_type">
              <option>æŸ¥è¯¢</option>
              <option>ä¸‹è½½</option>
            </select>
          </div>

          <div>
            <label>è§†é¢‘æ ¼å¼ä»£ç ï¼ˆä¸‹è½½ç”¨ï¼‰</label>
            <input name="video_format" placeholder="ä¾‹å¦‚ 251 / 137+140 / bestvideo+bestaudio ç­‰">
          </div>

          <div class="full">
            <label>YouTube è§†é¢‘é“¾æ¥</label>
            <input name="video_link" required placeholder="https://www.youtube.com/watch?v=...">
          </div>

          <div class="time-grid">
            <div>
              <label>å¯ç”¨æŒ‡å®šæ—¶é—´æ®µ</label>
              <select name="enable_sections">
                <option>å¦</option>
                <option>æ˜¯</option>
              </select>
            </div>

            <div class="time-pair" style="display: contents;">
              <div>
                <label>å¼€å§‹æ—¶é—´</label>
                <input name="start_time" placeholder="mm:ss æˆ– hh:mm:ss">
              </div>
              <div>
                <label>ç»“æŸæ—¶é—´</label>
                <input name="end_time" placeholder="mm:ss æˆ– hh:mm:ss">
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button id="btn" type="submit">æäº¤å¹¶è¿è¡Œ</button>
          <span id="status" class="muted"></span>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="row">
        <div><b>è¿è¡Œä¿¡æ¯</b></div>
        <div class="muted" id="runMeta"></div>
      </div>

      <div id="steps"></div>

      <h3 style="margin-top:16px;">Artifactsï¼ˆæ„å»ºå·¥ä»¶ï¼‰</h3>
      <div class="muted" id="artNote">ï¼ˆè¿è¡Œå®Œæˆåè‡ªåŠ¨åŠ è½½ï¼‰</div>
      <div id="artifacts"></div>

      <h3 style="margin-top:16px;">æŸ¥è¯¢ç»“æœï¼ˆformats.txtï¼‰</h3>
      <pre id="result">(ç­‰å¾…æŸ¥è¯¢å®Œæˆ...)</pre>
    </div>
  </div>

<script type="module">
  import { unzipSync, strFromU8 } from "https://cdn.jsdelivr.net/npm/fflate@0.8.2/esm/browser.js";

  const WORKER_BASE = "https://ytdlp-actions-panel-api.yswwsy.workers.dev";

  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function parseYouTubeId(input){
    try{
      const u = new URL(input);
      // watch?v=
      const v = u.searchParams.get("v");
      if (v) return v;

      // youtu.be/<id>
      if (u.hostname.includes("youtu.be")) {
        const id = u.pathname.split("/").filter(Boolean)[0];
        if (id) return id;
      }

      // shorts/<id>
      const parts = u.pathname.split("/").filter(Boolean);
      const shortsIdx = parts.indexOf("shorts");
      if (shortsIdx >= 0 && parts[shortsIdx+1]) return parts[shortsIdx+1];

      return null;
    } catch {
      return null;
    }
  }

  function ytThumbFromId(id){
    return id ? `https://i.ytimg.com/vi/${id}/hqdefault.jpg` : null;
  }

  function shieldDownloadBadge(resolution){
    // static/v1 é¿å… label-message-color çš„è¿å­—ç¬¦åˆ†éš”å‘
    const label = "YouTube";
    const message = resolution
      ? `ä¸‹è½½zipï¼ˆç»Workerï¼‰ ğŸï¸ ${resolution}`
      : `ä¸‹è½½zipï¼ˆç»Workerï¼‰`;

    const url = new URL("https://img.shields.io/static/v1");
    url.searchParams.set("label", label);
    url.searchParams.set("message", message);
    url.searchParams.set("color", "FF0000");
    url.searchParams.set("style", "plastic");
    url.searchParams.set("logo", "youtube");
    url.searchParams.set("logoColor", "white");
    return url.toString();
  }

  function renderSteps(jobsJson){
    const jobs = jobsJson.jobs || [];
    let html = `<div class="table-wrap"><table><thead><tr><th>Job</th><th>Step</th><th>Status</th><th>Conclusion</th></tr></thead><tbody>`;
    for(const job of jobs){
      for(const s of (job.steps || [])){
        html += `<tr>
          <td>${esc(job.name || "")}</td>
          <td>${esc(s.name || "")}</td>
          <td>${esc(s.status || "")}</td>
          <td>${esc(s.conclusion || "")}</td>
        </tr>`;
      }
    }
    html += "</tbody></table></div>";
    $("steps").innerHTML = html;
  }

  function humanBytes(n){
    if (n == null) return "";
    const units = ["B","KB","MB","GB"];
    let i = 0, x = Number(n);
    while (x >= 1024 && i < units.length-1){ x/=1024; i++; }
    return `${x.toFixed(i===0?0:2)} ${units[i]}`;
  }

  async function fetchJSON(path){
    const r = await fetch(WORKER_BASE + path, { credentials: "include" });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  async function postJSON(path, body){
    const r = await fetch(WORKER_BASE + path, {
      method:"POST",
      credentials: "include",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  async function downloadZipAndExtractText(runId, artifactName, targetSuffix){
    const zipResp = await fetch(
      WORKER_BASE + `/artifact-zip?run_id=${encodeURIComponent(runId)}&name=${encodeURIComponent(artifactName)}`,
      { credentials:"include" }
    );
    if(!zipResp.ok){
      throw new Error(await zipResp.text());
    }
    const buf = await zipResp.arrayBuffer();
    const files = unzipSync(new Uint8Array(buf));
    const key = Object.keys(files).find(k => k.endsWith(targetSuffix));
    if(!key) throw new Error(`zip ä¸­æœªæ‰¾åˆ° ${targetSuffix}`);
    return strFromU8(files[key]);
  }

  async function tryLoadMeta(runId, requestId, artifactsJson){
    const metaName = `meta-${requestId}`;
    const exists = (artifactsJson.artifacts || []).some(a => a.name === metaName);
    if(!exists) return null;

    const txt = await downloadZipAndExtractText(runId, metaName, "meta.json");
    return JSON.parse(txt);
  }

  function renderArtifacts(runId, requestId, artifactsJson, meta, thumbUrlFallback){
    const arts = artifactsJson.artifacts || [];
    if(!arts.length){
      $("artifacts").innerHTML = "<div class='muted'>ï¼ˆè¯¥ run æ²¡æœ‰ artifactsï¼‰</div>";
      return;
    }

    const queryName = `query-result-${requestId}`;
    const downloadName = `downloaded-videos-${requestId}`;

    const thumbUrl = meta?.thumbnail || thumbUrlFallback || "";

    let html = `<div class="table-wrap"><table>
      <thead><tr><th>é¢„è§ˆ</th><th>Name</th><th>Size</th><th>æ“ä½œ</th></tr></thead><tbody>`;

    for(const a of arts){
      const name = a.name;
      const size = a.size_in_bytes;

      const proxyZip = `${WORKER_BASE}/artifact-zip?run_id=${encodeURIComponent(runId)}&name=${encodeURIComponent(name)}`;
      const ghUi = `https://github.com/pdahd/ytdlp-actions-panel/actions/runs/${encodeURIComponent(runId)}/artifacts/${encodeURIComponent(a.id)}`;

      const badges = [];
      if(name === queryName) badges.push(`<span class="pill">query</span>`);
      if(name === downloadName) badges.push(`<span class="pill">download</span>`);

      // â€œä¸‹è½½zipï¼ˆç»Workerï¼‰â€æŒ‰é’®ï¼šå¯¹ downloaded-videos ç”¨ YouTube å¾½ç« ï¼ˆå«çœŸå®åˆ†è¾¨ç‡ï¼‰
      let workerDownloadHtml = `<a href="${proxyZip}">ä¸‹è½½zipï¼ˆç»Workerï¼‰</a>`;
      if(name === downloadName){
        const res = meta?.selected?.resolution || null;
        const badgeUrl = shieldDownloadBadge(res);
        workerDownloadHtml = `<a href="${proxyZip}">
          <img class="badge-img" src="${badgeUrl}" alt="download badge">
        </a>`;
      }

      html += `<tr>
        <td>${thumbUrl ? `<img class="thumb" src="${esc(thumbUrl)}" alt="thumb" loading="lazy">` : ""}</td>
        <td>${esc(name)} ${badges.join(" ")}</td>
        <td>${esc(humanBytes(size))}</td>
        <td>
          ${workerDownloadHtml}
          &nbsp;|&nbsp;
          <a href="${ghUi}" target="_blank">GitHubé“¾æ¥</a>
        </td>
      </tr>`;
    }

    html += "</tbody></table></div>";
    $("artifacts").innerHTML = html;
  }

  $("f").addEventListener("submit", async (e) => {
    e.preventDefault();
    $("btn").disabled = true;

    $("result").textContent = "(ç­‰å¾…æŸ¥è¯¢å®Œæˆ...)";
    $("steps").innerHTML = "";
    $("runMeta").textContent = "";
    $("artifacts").innerHTML = "";
    $("artNote").textContent = "ï¼ˆè¿è¡Œå®Œæˆåè‡ªåŠ¨åŠ è½½ï¼‰";
    $("status").textContent = "æ­£åœ¨è§¦å‘å·¥ä½œæµ...";

    const fd = new FormData(e.target);
    const request_id = uuid();

    const inputs = {
      request_id,
      action_type: fd.get("action_type"),
      video_link: fd.get("video_link"),
      video_format: fd.get("video_format") || "",
      enable_sections: fd.get("enable_sections") || "å¦",
      start_time: fd.get("start_time") || "",
      end_time: fd.get("end_time") || "",
    };

    if(inputs.action_type === "ä¸‹è½½" && !inputs.video_format){
      alert("ä¸‹è½½æ¨¡å¼éœ€è¦å¡«å†™ è§†é¢‘æ ¼å¼ä»£ç ");
      $("btn").disabled = false;
      return;
    }

    const vid = parseYouTubeId(inputs.video_link);
    const thumbFallback = ytThumbFromId(vid);

    await postJSON("/dispatch", { ref: "main", inputs });
    $("status").textContent = `å·²è§¦å‘ï¼Œrequest_id=${request_id}ï¼Œæ­£åœ¨å®šä½ run...`;

    let run = null;
    for(let i=0;i<45;i++){
      const res = await fetchJSON(`/resolve?request_id=${encodeURIComponent(request_id)}`);
      if(res.found){ run = res.run; break; }
      await sleep(1000);
    }
    if(!run){
      $("status").textContent = "æœªèƒ½å®šä½åˆ° runï¼ˆå¯èƒ½ GitHub å»¶è¿Ÿï¼‰ã€‚è¯·ç¨åé‡è¯•æˆ–å» Actions é¡µé¢æŸ¥çœ‹ã€‚";
      $("btn").disabled = false;
      return;
    }

    const runId = run.id;
    $("runMeta").innerHTML = `run_id=${runId} | <a href="${run.html_url}" target="_blank">æ‰“å¼€ GitHub è¿è¡Œé¡µé¢</a>`;
    $("status").textContent = "è¿è¡Œä¸­...";

    let runInfo = null;
    while(true){
      runInfo = await fetchJSON(`/run?run_id=${runId}`);
      const jobs = await fetchJSON(`/jobs?run_id=${runId}`);
      renderSteps(jobs);

      const st = `${runInfo.status}${runInfo.conclusion ? " / " + runInfo.conclusion : ""}`;
      $("status").textContent = `çŠ¶æ€ï¼š${st}`;

      if(runInfo.status === "completed") break;
      await sleep(2000);
    }

    // completed åï¼šåŠ è½½ artifacts + å°è¯•è¯»å– meta.json
    let arts = null;
    let meta = null;
    try {
      $("artNote").textContent = "æ­£åœ¨åŠ è½½ artifacts...";
      arts = await fetchJSON(`/artifacts?run_id=${runId}`);
      meta = await tryLoadMeta(runId, request_id, arts);
      renderArtifacts(runId, request_id, arts, meta, thumbFallback);
      $("artNote").textContent = `å…± ${arts.total_count ?? (arts.artifacts||[]).length} ä¸ª artifacts`
        + (meta?.selected?.resolution ? `ï¼›è¯†åˆ«åˆ°åˆ†è¾¨ç‡ï¼š${meta.selected.resolution}` : "");
    } catch (err) {
      $("artNote").textContent = "åŠ è½½ artifacts/meta å¤±è´¥ï¼š" + String(err);
    }

    // æŸ¥è¯¢ï¼šä»ç„¶å±•ç¤º formats.txt
    if(inputs.action_type === "æŸ¥è¯¢" && runInfo.conclusion === "success"){
      const artName = `query-result-${request_id}`;
      $("status").textContent = "æŸ¥è¯¢å·²å®Œæˆï¼Œæ­£åœ¨è·å– formats.txt ...";
      try{
        const txt = await downloadZipAndExtractText(runId, artName, "formats.txt");
        $("result").textContent = txt;
      }catch(e){
        $("result").textContent = "ä¸‹è½½æŸ¥è¯¢ç»“æœ artifact å¤±è´¥ï¼š" + String(e);
      }
    } else {
      $("result").textContent = "ï¼ˆéæŸ¥è¯¢æ¨¡å¼ï¼Œæˆ–è¿è¡Œå¤±è´¥ã€‚è¯·åœ¨ä¸Šæ–¹ Artifacts åŒºä¸‹è½½æˆå“ï¼›æˆ–æ‰“å¼€ GitHub è¿è¡Œé¡µé¢æŸ¥çœ‹æ—¥å¿—ã€‚ï¼‰";
    }

    $("btn").disabled = false;
  });
</script>
</body>
</html>
