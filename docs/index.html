<!doctype html>
<!-- VERSION: PANEL_UI_v1.4_darkBG_topFix_runsHeaderBrickRed_dlnameLocalTime_conclusionPlaceholder -->
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>yt-dlp Actions Panel</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg0: #0a1224;
      --bg1: #101b33;
      --bg2: #0a0f1d;

      --app-bg:
        radial-gradient(1200px 700px at 10% -10%, rgba(120,160,255,.28), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(1000px 700px at 50% 110%, rgba(110,255,220,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg2) 100%);

      --text: #eef2ff;
      --muted: rgba(238,242,255,.80);

      --border2: rgba(255,255,255,.22);

      --input-bg: rgba(10,14,25,.55);
      --pre-bg: rgba(8,10,18,.60);

      --link: #a9baff;
      --btn: linear-gradient(180deg, #5f7cff 0%, #3f60ff 100%);
      --btn-border: rgba(255,255,255,.22);

      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);

      --radius: 18px;
      --radius2: 12px;
      --gap: 12px;

      --ok: #3ddc84;
      --bad: #ff5c7a;
      --warn: #ffd166;
      --skip: rgba(238,242,255,.55);

      --metal-a: #5a6684;
      --metal-b: #1b233a;
      --metal-c: #0b1225;

      --key-a:  #2a3f86;
      --key-b:  #15214d;
      --key-a2: #28407f;
      --key-b2: #141f49;
      --key-border: rgba(255,255,255,.18);

      --key-shadow-out: 0 14px 20px rgba(0,0,0,.50);
      --key-shadow-in:
        inset 0 1px 0 rgba(255,255,255,.20),
        inset 0 -16px 26px rgba(0,0,0,.52);
      --key-radius: 14px;

      --paper-a: #f3e8b0;
      --paper-b: #d8c77a;
      --paper-c: #b59b45;
    }

    html{
      height: 100%;
      min-height: 100%;
      background-color: var(--bg0);
      background-image: var(--app-bg);
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    body{
      margin: 0;
      min-height: 100vh;
      background-color: var(--bg0);
      background-image: var(--app-bg);
      background-attachment: fixed;
      background-repeat: no-repeat;
      overscroll-behavior-y: none;

      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", Arial;
      color: var(--text);
    }

    .wrap{ max-width: 980px; margin: 22px auto; padding: 0 16px; }
    a{ color: var(--link); }
    .muted{ font-size: 13px; color: var(--muted); }

    hr{
      border: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
      margin: 14px 0;
    }

    .card{
      position: relative;
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)) padding-box,
        linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.08), rgba(255,255,255,.22)) border-box;
      border: 1px solid transparent;
      box-shadow: var(--shadow);
      padding: 18px;
      overflow: hidden;

      backdrop-filter: blur(10px) saturate(140%);
      -webkit-backdrop-filter: blur(10px) saturate(140%);
    }
    .card::before{
      content:"";
      position:absolute;
      left: -10%;
      right: -10%;
      top: -28px;
      height: 74px;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,.16) 20%,
        rgba(255,255,255,.06) 45%,
        rgba(255,255,255,.14) 70%,
        transparent 100%);
      transform: rotate(-2deg);
      pointer-events:none;
    }

    .grid{ display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .grid > * { min-width: 0; }
    .full{ grid-column: 1 / -1; min-width: 0; }

    label{ display:block; font-size: 13px; opacity: .95; margin-bottom: 6px; }

    input, select{
      width: 100%;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.22);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        inset 0 -10px 25px rgba(0,0,0,.22);
    }
    input:focus, select:focus{
      border-color: rgba(160,190,255,.55);
      box-shadow:
        0 0 0 3px rgba(95,124,255,.18),
        inset 0 1px 0 rgba(255,255,255,.10),
        inset 0 -10px 25px rgba(0,0,0,.22);
    }

    .time-grid{
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: minmax(110px, 150px) 1fr 1fr;
      gap: var(--gap);
      align-items: end;
    }
    .time-grid > * { min-width: 0; }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; min-width:0; }
    button{
      padding: 10px 14px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.22);
      background: var(--btn);
      color:#fff;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    button:disabled{ opacity: .6; cursor:not-allowed; }

    pre{
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--pre-bg);
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      overflow:auto;
    }

    .table-wrap{
      width: 100%;
      overflow-x: auto;
      padding: 3px;
      border-radius: 16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.14), transparent 32%),
        linear-gradient(135deg, var(--metal-a) 0%, var(--metal-b) 42%, var(--metal-c) 100%);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow:
        0 12px 22px rgba(0,0,0,.40),
        inset 0 1px 0 rgba(255,255,255,.18),
        inset 0 -1px 0 rgba(0,0,0,.55);
      position: relative;
    }
    .table-wrap::before{
      content:"";
      position:absolute;
      left: 6px;
      right: 6px;
      top: 4px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.40), transparent);
      pointer-events:none;
      opacity: .85;
    }

    table.tbl{
      width:100%;
      min-width: 720px;
      border-collapse: separate;
      border-spacing: 8px;
      border-radius: 13px;
      overflow: hidden;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.12),
        inset 0 -16px 28px rgba(0,0,0,.45);
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(180deg, var(--paper-a), var(--paper-b) 55%, var(--paper-c));
    }

    th, td{
      padding: 10px 10px;
      font-size: 13px;
      vertical-align: top;
      border-radius: var(--key-radius);
    }

    th{
      position: sticky;
      top: 0;
      z-index: 3;
      text-align: left;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow:
        0 14px 22px rgba(0,0,0,.44),
        inset 0 1px 0 rgba(255,255,255,.20),
        inset 0 -14px 20px rgba(0,0,0,.45);
    }

    /* è¿è¡Œä¿¡æ¯è¡¨å¤´ï¼šç –çº¢ */
    .thead-runs th{
      background: linear-gradient(180deg, rgba(196,72,58,.92), rgba(78,20,16,1));
    }

    .thead-arts th{
      background: linear-gradient(180deg, rgba(165,110,255,.78), rgba(25,33,64,1));
    }

    tbody td{
      position: relative;
      isolation: isolate;
      background:
        radial-gradient(160px 110px at 18% 14%, rgba(255,255,255,.16), transparent 60%),
        linear-gradient(180deg, var(--key-a), var(--key-b));
      border: 1px solid var(--key-border);
      box-shadow: var(--key-shadow-out), var(--key-shadow-in);
      overflow: hidden;
    }
    tbody tr:nth-child(even) td{
      background:
        radial-gradient(160px 110px at 18% 14%, rgba(255,255,255,.16), transparent 60%),
        linear-gradient(180deg, var(--key-a2), var(--key-b2));
    }
    tbody td::before,
    tbody td::after{ z-index: 0; }
    tbody td::before{
      content:"";
      position:absolute;
      inset: 0;
      border-radius: var(--key-radius);
      pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.20), transparent 42%),
        radial-gradient(260px 160px at 22% 0%, rgba(255,255,255,.22), transparent 62%);
      opacity: .78;
      mix-blend-mode: screen;
    }
    tbody td::after{
      content:"";
      position:absolute;
      inset: 1px;
      border-radius: calc(var(--key-radius) - 1px);
      pointer-events:none;
      background:
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          rgba(255,255,255,0) 5px,
          rgba(255,255,255,0) 9px
        );
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.18),
        inset 0 -1px 0 rgba(0,0,0,.78),
        0 0 0 1px rgba(255,255,255,.08);
      opacity: .55;
    }
    .cell-inner{ position: relative; z-index: 2; }

    .c-success{ color: var(--ok); font-weight: 900; }
    .c-failure{ color: var(--bad); font-weight: 900; }
    .c-cancelled{ color: var(--warn); font-weight: 900; }
    .c-skipped{ color: var(--skip); font-weight: 900; }

    /* æ–°å¢ï¼šå ä½ç¬¦æ ·å¼ï¼ˆæœ¬æ¬¡å”¯ä¸€æ–°å¢æ ·å¼ï¼‰ */
    .c-pending{ color: rgba(238,242,255,.60); font-weight: 800; }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:12px;
      opacity:.95;
      margin-left:6px;
      background: rgba(255,255,255,.06);
    }

    .thumb{
      width: 96px;
      height: 54px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      display:block;
      box-shadow: 0 12px 22px rgba(0,0,0,.55);
      position: relative;
      z-index: 2;
    }

    .badge-img{
      height: 30px;
      max-width: 100%;
      vertical-align: middle;
      filter: drop-shadow(0 14px 20px rgba(0,0,0,.55));
    }

    .dl-btn{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(160px 110px at 18% 14%, rgba(255,255,255,.14), transparent 60%),
        linear-gradient(180deg, #2a355f, #1a2244);
      color: rgba(238,242,255,.95);
      text-decoration: none;
      box-shadow:
        0 12px 18px rgba(0,0,0,.46),
        inset 0 1px 0 rgba(255,255,255,.16),
        inset 0 -14px 22px rgba(0,0,0,.45);
      white-space: nowrap;
    }
    .dl-btn:active{ transform: translateY(1px); }

    .toggle{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      user-select: none;
    }
    .toggle input{ width: 16px; height: 16px; }

    .video-meta{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .video-meta .title{
      font-weight: 900;
      line-height: 1.25;
      margin-bottom: 4px;
    }
    .video-meta .line{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .chip{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: rgba(238,242,255,.86);
    }

    .name-main{
      font-weight: 900;
      line-height: 1.25;
      max-width: 520px;
    }
    .name-sub{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(238,242,255,.72);
      word-break: break-all;
    }

    @media (max-width: 720px){
      .wrap{ padding: 0 12px; }
      .grid{ grid-template-columns: 1fr; }
      table.tbl{ min-width: 680px; border-spacing: 7px; }
    }
    @media (max-width: 520px){
      .time-grid{ grid-template-columns: 1fr; }
      .time-grid .time-pair{
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
      }
      .time-grid .time-pair > *{ min-width:0; }
      table.tbl{ border-spacing: 6px; }
    }
    @media (max-width: 380px){
      .time-grid .time-pair{ grid-template-columns: 1fr; }
      .name-main{ max-width: 280px; }
      table.tbl{ border-spacing: 5px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px;">yt-dlp Actions æ§åˆ¶å°</h2>
      <div class="muted">ç½‘é¡µè¡¨å• â†’ Cloudflare Worker â†’ workflow_dispatch â†’ è½®è¯¢ run/jobs â†’ å±•ç¤ºç»“æœ + artifacts ä¸‹è½½</div>

      <hr>

      <form id="f">
        <div class="grid">
          <div>
            <label>æ“ä½œç±»å‹</label>
            <select name="action_type">
              <option>æŸ¥è¯¢</option>
              <option>ä¸‹è½½</option>
            </select>
          </div>

          <div>
            <label>è§†é¢‘æ ¼å¼ä»£ç ï¼ˆä¸‹è½½ç”¨ï¼‰</label>
            <input name="video_format" placeholder="ä¾‹å¦‚ 251 / 137+140 / bestvideo+bestaudio ç­‰">
          </div>

          <div class="full">
            <label>YouTube è§†é¢‘é“¾æ¥</label>
            <input name="video_link" required placeholder="https://www.youtube.com/watch?v=...">
          </div>

          <div class="time-grid">
            <div>
              <label>å¯ç”¨æŒ‡å®šæ—¶é—´æ®µ</label>
              <select name="enable_sections">
                <option>å¦</option>
                <option>æ˜¯</option>
              </select>
            </div>

            <div class="time-pair" style="display: contents;">
              <div>
                <label>å¼€å§‹æ—¶é—´</label>
                <input name="start_time" placeholder="mm:ss æˆ– hh:mm:ss">
              </div>
              <div>
                <label>ç»“æŸæ—¶é—´</label>
                <input name="end_time" placeholder="mm:ss æˆ– hh:mm:ss">
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button id="btn" type="submit">æäº¤å¹¶è¿è¡Œ</button>
          <span id="status" class="muted"></span>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="row">
        <div><b>è¿è¡Œä¿¡æ¯</b></div>
        <div class="muted" id="runMeta"></div>
      </div>

      <div id="videoMeta" class="video-meta" style="display:none;"></div>

      <div id="steps" style="margin-top:12px;"></div>

      <div class="row" style="margin-top:14px; justify-content: space-between;">
        <h3 style="margin:0;">Artifactsï¼ˆæ„å»ºå·¥ä»¶ï¼‰</h3>
        <label class="toggle">
          <input id="showMeta" type="checkbox">
          <span class="muted">æ˜¾ç¤º meta å·¥ä»¶</span>
        </label>
      </div>

      <div class="muted" id="artNote" style="margin-top:6px;">ï¼ˆè¿è¡Œå®Œæˆåè‡ªåŠ¨åŠ è½½ï¼‰</div>
      <div id="artifacts"></div>

      <h3 style="margin-top:16px;">æŸ¥è¯¢ç»“æœï¼ˆformats.txtï¼‰</h3>
      <pre id="result">(ç­‰å¾…æŸ¥è¯¢å®Œæˆ...)</pre>
    </div>
  </div>

<script type="module">
  import { unzipSync, strFromU8 } from "https://cdn.jsdelivr.net/npm/fflate@0.8.2/esm/browser.js";

  const WORKER_BASE = "https://ytdlp-actions-panel-api.yswwsy.workers.dev";

  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function escAttr(s){
    return String(s).replace(/["&<>]/g, c => ({
      '"':"&quot;","&":"&amp;","<":"&lt;",">":"&gt;"
    }[c]));
  }

  function localTimestamp(){
    const d = new Date();
    const p2 = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}${p2(d.getMonth()+1)}${p2(d.getDate())}-${p2(d.getHours())}${p2(d.getMinutes())}${p2(d.getSeconds())}`;
  }

  function buildArtifactZipUrl(runId, artName, dlPrefix){
    const ts = localTimestamp();
    const dlname = `${dlPrefix}-${ts}.zip`;
    const u = new URL(WORKER_BASE + "/artifact-zip");
    u.searchParams.set("run_id", runId);
    u.searchParams.set("name", artName);
    u.searchParams.set("dlname", dlname);
    return u.toString();
  }

  document.addEventListener("click", (e) => {
    const a = e.target.closest("a[data-dl='1']");
    if (!a) return;

    const runId = a.dataset.runid;
    const artName = a.dataset.artname;
    const prefix = a.dataset.prefix || "Artifact";
    if (!runId || !artName) return;

    a.href = buildArtifactZipUrl(runId, artName, prefix);
  }, { capture: true });

  function parseYouTubeId(input){
    try{
      const u = new URL(input);
      const v = u.searchParams.get("v");
      if (v) return v;
      if (u.hostname.includes("youtu.be")) {
        const id = u.pathname.split("/").filter(Boolean)[0];
        if (id) return id;
      }
      const parts = u.pathname.split("/").filter(Boolean);
      const shortsIdx = parts.indexOf("shorts");
      if (shortsIdx >= 0 && parts[shortsIdx+1]) return parts[shortsIdx+1];
      return null;
    } catch {
      return null;
    }
  }

  function ytThumbFromId(id){
    return id ? `https://i.ytimg.com/vi/${id}/hqdefault.jpg` : null;
  }

  function shieldDownloadBadge(resolution){
    const label = "YouTube";
    const message = resolution ? `ä¸‹è½½zip ${resolution}` : `ä¸‹è½½zip`;
    const url = new URL("https://img.shields.io/static/v1");
    url.searchParams.set("label", label);
    url.searchParams.set("message", message);
    url.searchParams.set("color", "3f60ff");
    url.searchParams.set("labelColor", "FF0000");
    url.searchParams.set("style", "plastic");
    url.searchParams.set("logo", "youtube");
    url.searchParams.set("logoColor", "white");
    return url.toString();
  }

  async function fetchJSON(path){
    const r = await fetch(WORKER_BASE + path, { credentials: "include" });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  async function postJSON(path, body){
    const r = await fetch(WORKER_BASE + path, {
      method:"POST",
      credentials: "include",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok) throw new Error(t);
    return JSON.parse(t);
  }

  function clsForConclusion(conc){
    const v = String(conc || "").toLowerCase();
    if (v === "success") return "c-success";
    if (v === "failure") return "c-failure";
    if (v === "cancelled") return "c-cancelled";
    if (v === "skipped") return "c-skipped";
    return "";
  }

  function renderSteps(jobsJson){
    const jobs = jobsJson.jobs || [];
    let html = `<div class="table-wrap"><table class="tbl">
      <thead class="thead-runs"><tr><th>Job</th><th>Step</th><th>Status</th><th>Conclusion</th></tr></thead><tbody>`;

    for(const job of jobs){
      for(const s of (job.steps || [])){
        const status = s.status || "";
        const rawConc = s.conclusion;

        // === æœ¬æ¬¡æ”¹åŠ¨ï¼šconclusion ä¸ºç©ºæ—¶æ˜¾ç¤ºå ä½ç¬¦ ===
        let concText;
        let cls;
        if (rawConc === null || rawConc === undefined || rawConc === "") {
          concText = (status && status !== "completed") ? "â€¦" : "â€”";
          cls = "c-pending";
        } else {
          concText = rawConc;
          cls = clsForConclusion(concText);
        }

        html += `<tr>
          <td><div class="cell-inner">${esc(job.name || "")}</div></td>
          <td><div class="cell-inner">${esc(s.name || "")}</div></td>
          <td><div class="cell-inner">${esc(status)}</div></td>
          <td class="${cls}"><div class="cell-inner">${esc(concText)}</div></td>
        </tr>`;
      }
    }

    html += "</tbody></table></div>";
    $("steps").innerHTML = html;
  }

  function humanBytes(n){
    if (n == null) return "";
    const units = ["B","KB","MB","GB"];
    let i = 0, x = Number(n);
    while (x >= 1024 && i < units.length-1){ x/=1024; i++; }
    return `${x.toFixed(i===0?0:2)} ${units[i]}`;
  }

  async function downloadZipAndExtractText(runId, artifactName, targetSuffix){
    const u = new URL(WORKER_BASE + "/artifact-zip");
    u.searchParams.set("run_id", runId);
    u.searchParams.set("name", artifactName);

    const zipResp = await fetch(u.toString(), { credentials:"include" });
    if(!zipResp.ok){
      throw new Error(await zipResp.text());
    }
    const buf = await zipResp.arrayBuffer();
    const files = unzipSync(new Uint8Array(buf));
    const key = Object.keys(files).find(k => k.endsWith(targetSuffix));
    if(!key) throw new Error(`zip ä¸­æœªæ‰¾åˆ° ${targetSuffix}`);
    return strFromU8(files[key]);
  }

  async function tryLoadMeta(runId, requestId, artifactsJson){
    const metaName = `meta-${requestId}`;
    const exists = (artifactsJson.artifacts || []).some(a => a.name === metaName);
    if(!exists) return null;
    const txt = await downloadZipAndExtractText(runId, metaName, "meta.json");
    return JSON.parse(txt);
  }

  function renderVideoMeta(meta){
    const box = $("videoMeta");
    if(!meta){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    const title = meta.title || "(æ— æ ‡é¢˜)";
    const dur = meta.duration == null ? null : (()=>{
      const s = Math.max(0, Math.floor(Number(meta.duration)));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const r = s % 60;
      const p2 = (n)=>String(n).padStart(2,"0");
      return h>0 ? `${h}:${p2(m)}:${p2(r)}` : `${m}:${p2(r)}`;
    })();

    const channel = meta.channel || meta.uploader || "";
    const res = meta?.selected?.resolution || "";
    const fmt = meta.requested_format || "";

    box.innerHTML = `
      <div class="title">${esc(title)}</div>
      <div class="line">
        ${dur ? `<span class="chip">â± ${esc(dur)}</span>` : ``}
        ${channel ? `<span class="chip">ğŸ“º ${esc(channel)}</span>` : ``}
        ${res ? `<span class="chip">ğŸï¸ ${esc(res)}</span>` : ``}
        ${fmt ? `<span class="chip">fmt=${esc(fmt)}</span>` : ``}
      </div>
    `;
    box.style.display = "block";
  }

  function shouldShowArtifact(name){
    const showMeta = $("showMeta").checked;
    if (name.startsWith("meta-")) return showMeta;
    return true;
  }

  function renderArtifacts(runId, requestId, artifactsJson, meta, thumbUrlFallback){
    const artsAll = artifactsJson.artifacts || [];
    const arts = artsAll.filter(a => shouldShowArtifact(a.name));
    if(!arts.length){
      $("artifacts").innerHTML = "<div class='muted'>ï¼ˆå½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯æ˜¾ç¤ºçš„ artifactsï¼‰</div>";
      return;
    }

    const queryName = `query-result-${requestId}`;
    const downloadName = `downloaded-videos-${requestId}`;
    const thumbUrl = meta?.thumbnail || thumbUrlFallback || "";

    let html = `<div class="table-wrap"><table class="tbl">
      <thead class="thead-arts"><tr><th>é¢„è§ˆ</th><th>Name</th><th>Size</th><th>ä¸‹è½½</th></tr></thead><tbody>`;

    for(const a of arts){
      const name = a.name;
      const size = a.size_in_bytes;

      const badges = [];
      if(name === queryName) badges.push(`<span class="pill">query</span>`);
      if(name === downloadName) badges.push(`<span class="pill">download</span>`);
      if(name.startsWith("meta-")) badges.push(`<span class="pill">meta</span>`);

      let nameCell = `<div class="cell-inner"><div class="name-main">${esc(name)}</div></div>`;
      if(name === downloadName && meta?.title){
        nameCell = `
          <div class="cell-inner">
            <div class="name-main">${esc(meta.title)}</div>
            <div class="name-sub">${esc(name)}</div>
          </div>`;
      } else if (name.startsWith("meta-")) {
        nameCell = `
          <div class="cell-inner">
            <div class="name-main">meta.json</div>
            <div class="name-sub">${esc(name)}</div>
          </div>`;
      } else if (name === queryName) {
        nameCell = `
          <div class="cell-inner">
            <div class="name-main">formats.txt</div>
            <div class="name-sub">${esc(name)}</div>
          </div>`;
      }

      const baseHref = `${WORKER_BASE}/artifact-zip?run_id=${encodeURIComponent(runId)}&name=${encodeURIComponent(name)}`;

      let prefix = "Artifact";
      if (name === downloadName) prefix = "YouTube";
      else if (name === queryName) prefix = "Formats";
      else if (name.startsWith("meta-")) prefix = "Meta";

      let downloadHtml = `
        <div class="cell-inner">
          <a class="dl-btn" data-dl="1" data-runid="${escAttr(runId)}" data-artname="${escAttr(name)}" data-prefix="${escAttr(prefix)}"
             href="${escAttr(baseHref)}">â¬‡ ä¸‹è½½zip</a>
        </div>`;

      if(name === downloadName){
        const res = meta?.selected?.resolution || null;
        downloadHtml = `
          <div class="cell-inner">
            <a data-dl="1" data-runid="${escAttr(runId)}" data-artname="${escAttr(name)}" data-prefix="${escAttr(prefix)}"
               href="${escAttr(baseHref)}">
              <img class="badge-img" src="${escAttr(shieldDownloadBadge(res))}" alt="download badge">
            </a>
          </div>`;
      }

      html += `<tr>
        <td><div class="cell-inner">${thumbUrl ? `<img class="thumb" src="${escAttr(thumbUrl)}" alt="thumb" loading="lazy">` : ""}</div></td>
        <td>${nameCell} ${badges.join(" ")}</td>
        <td><div class="cell-inner">${esc(humanBytes(size))}</div></td>
        <td>${downloadHtml}</td>
      </tr>`;
    }

    html += "</tbody></table></div>";
    $("artifacts").innerHTML = html;
  }

  // ä¸»æµç¨‹
  $("f").addEventListener("submit", async (e) => {
    e.preventDefault();
    $("btn").disabled = true;

    $("result").textContent = "(ç­‰å¾…æŸ¥è¯¢å®Œæˆ...)";
    $("steps").innerHTML = "";
    $("runMeta").textContent = "";
    $("artifacts").innerHTML = "";
    $("artNote").textContent = "ï¼ˆè¿è¡Œå®Œæˆåè‡ªåŠ¨åŠ è½½ï¼‰";
    $("status").textContent = "æ­£åœ¨è§¦å‘å·¥ä½œæµ...";
    renderVideoMeta(null);

    const fd = new FormData(e.target);
    const request_id = uuid();

    const inputs = {
      request_id,
      action_type: fd.get("action_type"),
      video_link: fd.get("video_link"),
      video_format: fd.get("video_format") || "",
      enable_sections: fd.get("enable_sections") || "å¦",
      start_time: fd.get("start_time") || "",
      end_time: fd.get("end_time") || "",
    };

    if(inputs.action_type === "ä¸‹è½½" && !inputs.video_format){
      alert("ä¸‹è½½æ¨¡å¼éœ€è¦å¡«å†™ è§†é¢‘æ ¼å¼ä»£ç ");
      $("btn").disabled = false;
      return;
    }

    const vid = parseYouTubeId(inputs.video_link);
    const thumbFallback = ytThumbFromId(vid);

    await postJSON("/dispatch", { ref: "main", inputs });
    $("status").textContent = `å·²è§¦å‘ï¼Œrequest_id=${request_id}ï¼Œæ­£åœ¨å®šä½ run...`;

    let run = null;
    for(let i=0;i<45;i++){
      const res = await fetchJSON(`/resolve?request_id=${encodeURIComponent(request_id)}`);
      if(res.found){ run = res.run; break; }
      await sleep(1000);
    }
    if(!run){
      $("status").textContent = "æœªèƒ½å®šä½åˆ° runï¼ˆå¯èƒ½ GitHub å»¶è¿Ÿï¼‰ã€‚è¯·ç¨åé‡è¯•æˆ–å» Actions é¡µé¢æŸ¥çœ‹ã€‚";
      $("btn").disabled = false;
      return;
    }

    const runId = run.id;
    $("runMeta").innerHTML = `run_id=${runId} | <a href="${run.html_url}" target="_blank">æ‰“å¼€ GitHub è¿è¡Œé¡µé¢</a>`;
    $("status").textContent = "è¿è¡Œä¸­...";

    let runInfo = null;
    while(true){
      runInfo = await fetchJSON(`/run?run_id=${runId}`);
      const jobs = await fetchJSON(`/jobs?run_id=${runId}`);
      renderSteps(jobs);

      const st = `${runInfo.status}${runInfo.conclusion ? " / " + runInfo.conclusion : ""}`;
      $("status").textContent = `çŠ¶æ€ï¼š${st}`;

      if(runInfo.status === "completed") break;
      await sleep(2000);
    }

    try {
      $("artNote").textContent = "æ­£åœ¨åŠ è½½ artifacts...";
      const arts = await fetchJSON(`/artifacts?run_id=${runId}`);
      const meta = await tryLoadMeta(runId, request_id, arts);

      renderVideoMeta(meta);
      renderArtifacts(runId, request_id, arts, meta, thumbFallback);

      $("artNote").textContent = `å…± ${arts.total_count ?? (arts.artifacts||[]).length} ä¸ª artifacts`
        + (meta?.selected?.resolution ? `ï¼›è¯†åˆ«åˆ°åˆ†è¾¨ç‡ï¼š${meta.selected.resolution}` : "");
    } catch (err) {
      $("artNote").textContent = "åŠ è½½ artifacts/meta å¤±è´¥ï¼š" + String(err);
    }

    if(inputs.action_type === "æŸ¥è¯¢" && runInfo.conclusion === "success"){
      const artName = `query-result-${request_id}`;
      $("status").textContent = "æŸ¥è¯¢å·²å®Œæˆï¼Œæ­£åœ¨è·å– formats.txt ...";
      try{
        const txt = await downloadZipAndExtractText(runId, artName, "formats.txt");
        $("result").textContent = txt;
      }catch(e){
        $("result").textContent = "ä¸‹è½½æŸ¥è¯¢ç»“æœ artifact å¤±è´¥ï¼š" + String(e);
      }
    } else {
      $("result").textContent = "ï¼ˆéæŸ¥è¯¢æ¨¡å¼ï¼Œæˆ–è¿è¡Œå¤±è´¥ã€‚è¯·åœ¨ä¸Šæ–¹ Artifacts åŒºä¸‹è½½æˆå“ï¼›æˆ–æ‰“å¼€ GitHub è¿è¡Œé¡µé¢æŸ¥çœ‹æ—¥å¿—ã€‚ï¼‰";
    }

    $("btn").disabled = false;
  });
</script>
</body>
</html>
